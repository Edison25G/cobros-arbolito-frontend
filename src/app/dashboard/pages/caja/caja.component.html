<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="p-2 sm:p-6 animate-fade-in min-h-[85vh]">
	<h2 class="text-2xl font-extrabold text-gray-800 mb-6 flex items-center gap-2">
		<i class="pi pi-wallet text-green-600"></i>
		Caja y RecaudaciÃ³n
	</h2>

	<!-- NUEVA ESTRUCTURA DE TABS (PrimeNG v20) -->
	<p-tabs value="0">
		<!-- 1. Lista de PestaÃ±as (Encabezados) -->
		<p-tablist>
			<p-tab value="0"> <i class="pi pi-money-bill mr-2"></i> Cobro en Ventanilla </p-tab>
			<p-tab value="1"> <i class="pi pi-image mr-2"></i> Validar Transferencias </p-tab>
		</p-tablist>

		<!-- 2. Contenido de las PestaÃ±as -->
		<p-tabpanels>
			<!-- PANEL 0: Cobro en Ventanilla -->
			<p-tabpanel value="0">
				<div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mt-2">
					<!-- Columna Izquierda: Buscador y Datos Socio -->
					<div class="lg:col-span-4 space-y-4">
						<!-- Buscador -->
						<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
							<span class="block text-sm font-bold text-gray-700 mb-2">Buscar Socio</span>
							<div class="flex gap-2">
								<input
									pInputText
									[(ngModel)]="terminoBusqueda"
									(keyup.enter)="buscarSocio()"
									placeholder="CÃ©dula o Apellido..."
									class="w-full"
								/>
								<p-button icon="pi pi-search" [loading]="buscando" (onClick)="buscarSocio()"></p-button>
							</div>
							<small class="text-gray-400 mt-1 block">Presiona Enter para buscar</small>
						</div>

						<!-- Tarjeta de Socio Encontrado -->
						<div *ngIf="socioEncontrado" class="bg-blue-50 p-6 rounded-xl border border-blue-100 animate-fade-in-up">
							<div class="flex items-center gap-4 mb-4">
								<div
									class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-blue-600 text-2xl font-bold shadow-sm"
								>
									{{ socioEncontrado.nombres.charAt(0) }}
								</div>
								<div>
									<h3 class="font-bold text-gray-800 text-lg m-0">{{ socioEncontrado.nombres }}</h3>
									<p class="text-gray-600 text-sm">{{ socioEncontrado.apellidos }}</p>
								</div>
							</div>

							<div class="space-y-2 text-sm">
								<div class="flex justify-between">
									<span class="text-gray-500">CÃ©dula:</span>
									<span class="font-medium">{{ socioEncontrado.cedula }}</span>
								</div>
								<div class="flex justify-between">
									<span class="text-gray-500">Barrio:</span>
									<span class="font-medium">{{ socioEncontrado.barrio }}</span>
								</div>
								<div class="flex justify-between">
									<span class="text-gray-500">Estado:</span>
									<p-tag [value]="socioEncontrado.estado" severity="success"></p-tag>
								</div>
							</div>
						</div>
					</div>

					<!-- Columna Derecha: Tabla de Deudas -->
					<div class="lg:col-span-8">
						<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden h-full flex flex-col">
							<div class="p-4 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
								<h3 class="font-bold text-gray-700 m-0">Estado de Cuenta</h3>
								<span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full" *ngIf="deudas.length > 0">
									{{ deudas.length }} pendientes
								</span>
							</div>

							<div class="p-4 flex-1">
								<p-table [value]="deudas" *ngIf="deudas.length > 0; else vacio">
									<ng-template pTemplate="header">
										<tr>
											<th style="width: 3rem"></th>
											<th>Concepto</th>
											<th>Vencimiento</th>
											<th>Tipo</th>
											<th class="text-right">Monto</th>
										</tr>
									</ng-template>
									<ng-template pTemplate="body" let-item>
										<tr [ngClass]="{ 'bg-green-50': item.seleccionado }">
											<td>
												<p-checkbox
													[(ngModel)]="item.seleccionado"
													[binary]="true"
													(onChange)="calcularTotal()"
												></p-checkbox>
											</td>
											<td>
												<span class="font-medium text-gray-800">{{ item.concepto }}</span>
											</td>
											<td class="text-gray-500 text-sm">{{ item.vencimiento }}</td>
											<td>
												<p-tag [value]="item.tipo" [severity]="item.tipo === 'AGUA' ? 'info' : 'warn'"></p-tag>
											</td>
											<td class="text-right font-bold text-gray-800">
												{{ item.monto | currency }}
											</td>
										</tr>
									</ng-template>
								</p-table>

								<ng-template #vacio>
									<div class="flex flex-col items-center justify-center h-64 text-gray-400">
										<i class="pi pi-shopping-cart text-4xl mb-3 opacity-30"></i>
										<p *ngIf="!socioEncontrado">Busque un socio para ver sus deudas.</p>
										<p *ngIf="socioEncontrado">Este socio estÃ¡ al dÃ­a. Â¡Excelente! ðŸŽ‰</p>
									</div>
								</ng-template>
							</div>

							<!-- Footer con Total y BotÃ³n Pagar -->
							<div
								class="bg-gray-800 p-6 flex flex-col sm:flex-row justify-between items-center gap-4"
								*ngIf="deudas.length > 0"
							>
								<div>
									<span class="text-gray-400 text-sm uppercase font-bold">Total a Pagar</span>
									<div class="text-3xl font-bold text-green-400">{{ totalAPagar | currency }}</div>
								</div>
								<p-button
									label="Recibir Efectivo y Procesar"
									icon="pi pi-check"
									[loading]="procesandoPago"
									(onClick)="confirmarCobro()"
									styleClass="p-button-lg p-button-success font-bold px-8"
								>
								</p-button>
							</div>
						</div>
					</div>
				</div>
			</p-tabpanel>

			<!-- PANEL 1: Validar Transferencias -->
			<p-tabpanel value="1">
				<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
					<p class="mb-4 text-gray-600">
						Revise los comprobantes subidos por los socios y apruebe el pago si el dinero estÃ¡ en la cuenta.
					</p>

					<p-table [value]="transferencias" [loading]="cargandoTransferencias">
						<ng-template pTemplate="header">
							<tr>
								<th>Socio</th>
								<th>Banco / Fecha</th>
								<th>Monto</th>
								<th>Comprobante</th>
								<th>Acciones</th>
							</tr>
						</ng-template>
						<ng-template pTemplate="body" let-t>
							<tr>
								<td class="font-bold">{{ t.socio }}</td>
								<td>
									<div class="text-sm">{{ t.banco }}</div>
									<div class="text-xs text-gray-500">{{ t.fecha }}</div>
								</td>
								<td class="font-bold text-green-600">{{ t.monto | currency }}</td>
								<td>
									<p-image
										[src]="t.comprobante_url"
										alt="Comprobante"
										[preview]="true"
										width="50"
										class="rounded shadow-sm"
									>
									</p-image>
								</td>
								<td>
									<div class="flex gap-2">
										<p-button
											icon="pi pi-check"
											severity="success"
											[rounded]="true"
											pTooltip="Aprobar"
											(onClick)="aprobarTransferencia(t)"
										></p-button>
										<p-button
											icon="pi pi-times"
											severity="danger"
											[rounded]="true"
											[text]="true"
											pTooltip="Rechazar"
										></p-button>
									</div>
								</td>
							</tr>
						</ng-template>
					</p-table>
				</div>
			</p-tabpanel>
		</p-tabpanels>
	</p-tabs>
</div>
