<p-toast></p-toast>

<div class="p-2 sm:p-6 animate-fade-in min-h-[85vh] flex justify-center">
	<div class="w-full max-w-7xl bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col">
		<div
			class="bg-white px-4 py-4 sm:px-6 sm:py-5 border-b border-gray-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
		>
			<div class="flex items-center gap-3 w-full md:w-auto">
				<p-button
					icon="pi pi-arrow-left"
					[rounded]="true"
					[text]="true"
					severity="secondary"
					routerLink="/dashboard/lecturas"
				>
				</p-button>
				<div>
					<h2 class="text-lg sm:text-2xl font-extrabold text-gray-800 m-0 leading-tight">Registro de Lecturas</h2>
					<p class="text-xs sm:text-sm text-gray-500">Planilla de carga masiva</p>
				</div>
			</div>

			<div class="w-full md:w-auto bg-gray-50 p-1.5 rounded-lg border border-gray-200 flex items-center">
				<span class="text-xs font-bold text-gray-500 px-2 uppercase tracking-wide">Corte:</span>
				<p-datepicker
					[(ngModel)]="fechaLectura"
					dateFormat="dd/mm/yy"
					appendTo="body"
					[showIcon]="true"
					styleClass="w-full border-0"
					inputStyleClass="bg-transparent border-none font-bold text-gray-700 w-full md:w-32 text-sm focus:ring-0"
				>
				</p-datepicker>
			</div>
		</div>

		<div class="p-4 sm:p-6 flex-1 flex flex-col">
			<div class="mb-6 grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
				<div class="md:col-span-8 lg:col-span-9">
					<span class="block text-sm font-bold text-gray-700 mb-2 ml-1">
						<i class="pi pi-map-marker text-green-600 mr-1"></i> Seleccione Barrio
					</span>
					<p-select
						[options]="barrios"
						[(ngModel)]="barrioSeleccionado"
						optionLabel="label"
						optionValue="value"
						placeholder="Seleccione un sector..."
						(onChange)="cargarPlanilla()"
						styleClass="w-full p-inputtext-lg"
						[showClear]="true"
					>
					</p-select>
				</div>

				<div class="md:col-span-4 lg:col-span-3">
					<div
						class="h-full flex items-center justify-center bg-blue-50 border border-blue-100 rounded-lg px-4 py-3 text-blue-700 text-sm font-medium"
					>
						<i class="pi pi-info-circle mr-2 text-blue-500"></i>
						<span *ngIf="filas.length > 0">{{ filas.length }} medidores activos</span>
						<span *ngIf="filas.length === 0">Sin datos cargados</span>
					</div>
				</div>
			</div>

			<div
				*ngIf="barrioSeleccionado && filas.length > 0; else emptyState"
				class="animate-fade-in-up flex-1 flex flex-col"
			>
				<div class="border border-gray-200 rounded-xl overflow-hidden shadow-sm bg-white mb-4">
					<p-table
						[value]="filas"
						[scrollable]="true"
						scrollHeight="60vh"
						styleClass="p-datatable-sm p-datatable-gridlines"
						[rowHover]="true"
					>
						<ng-template pTemplate="header">
							<tr class="bg-gray-50 text-xs uppercase tracking-wider text-gray-600 font-semibold">
								<th style="min-width: 200px" class="py-3">Socio / Cliente</th>
								<th style="min-width: 120px" class="text-center">Medidor</th>
								<th style="min-width: 120px" class="text-center">Lect. Ant.</th>
								<th style="min-width: 160px" class="text-center bg-blue-50/80 text-blue-800">Lectura Actual</th>
								<th style="min-width: 120px" class="text-center">Consumo</th>
								<th style="min-width: 80px" class="text-center">Estado</th>
							</tr>
						</ng-template>

						<ng-template pTemplate="body" let-fila>
							<tr class="align-middle transition-colors duration-300" [ngClass]="{ 'bg-green-50': fila.procesado }">
								<td class="py-3 px-4 font-medium text-gray-700">
									<div class="flex flex-col">
										<span class="text-sm font-bold uppercase tracking-tight">
											{{ fila.medidor.nombre_socio || 'Sin Asignar' }}
										</span>
										<span class="text-[11px] text-gray-400 font-medium flex items-center gap-1 mt-1">
											<i class="pi pi-user text-[10px]"></i> Socio Activo
										</span>
									</div>
								</td>

								<td class="text-center">
									<span
										class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-md font-mono font-bold border border-gray-200"
									>
										{{ fila.medidor.codigo }}
									</span>
								</td>

								<td class="text-center text-gray-500 text-sm font-semibold">
									{{ fila.lecturaAnterior }} <span class="text-xs">m³</span>
								</td>

								<td class="p-2 relative">
									<div class="w-full">
										<p-inputNumber
											[(ngModel)]="fila.lecturaActual"
											(onInput)="calcularConsumo(fila)"
											[min]="0"
											mode="decimal"
											[disabled]="fila.procesado"
											placeholder="0.00"
											styleClass="w-full"
											inputStyleClass="w-full text-center font-bold text-lg rounded-lg py-2 transition-all border-2 {{
												fila.error
													? 'bg-red-50 border-red-400 text-red-700 focus:ring-red-200'
													: 'bg-white border-gray-300 text-gray-800 focus:border-blue-500 focus:ring-4 focus:ring-blue-100'
											}}"
										>
										</p-inputNumber>

										<div
											*ngIf="fila.error"
											class="absolute left-0 right-0 -bottom-1 flex justify-center pointer-events-none z-20"
										>
											<span
												class="text-[10px] font-bold bg-red-500 text-white px-2 py-0.5 rounded-full shadow-sm animate-fade-in"
											>
												Menor a anterior
											</span>
										</div>
									</div>
								</td>

								<td class="text-center">
									<span
										*ngIf="fila.consumo > 0"
										class="font-bold text-green-600 text-base bg-green-50 px-2 py-1 rounded-md"
									>
										+{{ fila.consumo | number: '1.2-2' }}
									</span>
									<span *ngIf="fila.consumo === 0" class="text-gray-300 font-bold text-xl">·</span>
								</td>

								<td class="text-center">
									<i *ngIf="fila.procesado" class="pi pi-check-circle text-green-500 text-xl scale-110"></i>
									<i *ngIf="!fila.procesado && !fila.error" class="pi pi-circle text-gray-200 text-lg"></i>
									<i *ngIf="fila.error" class="pi pi-exclamation-triangle text-red-400 text-lg animate-pulse"></i>
								</td>
							</tr>
						</ng-template>
					</p-table>
				</div>
				<div class="mt-auto pt-4 border-t border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4">
					<div class="text-xs text-gray-400 hidden sm:block">* Las lecturas se guardan en lote al finalizar.</div>
					<p-button
						label="Guardar Planilla"
						icon="pi pi-save"
						[loading]="guardando"
						(onClick)="guardarPlanilla()"
						styleClass="w-full sm:w-auto p-button-lg shadow-md font-bold text-white bg-green-600 border-green-600 hover:bg-green-700"
					>
					</p-button>
				</div>
			</div>

			<ng-template #emptyState>
				<div
					class="flex flex-col items-center justify-center py-20 text-gray-400 border-2 border-dashed border-gray-100 rounded-xl bg-gray-50/50 mt-4"
				>
					<div class="bg-white p-4 rounded-full shadow-sm mb-3">
						<i class="pi pi-table text-3xl text-blue-200"></i>
					</div>
					<p *ngIf="!barrioSeleccionado" class="text-sm">Seleccione un barrio arriba para cargar la lista.</p>
					<p *ngIf="barrioSeleccionado" class="text-sm font-medium text-gray-600">
						No hay medidores físicos en este barrio.
					</p>
				</div>
			</ng-template>
		</div>
	</div>
</div>
