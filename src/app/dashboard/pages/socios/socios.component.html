<app-page-header title="Gesti贸n de Socios" subtitle="Administra el padr贸n de usuarios y sus roles"
	buttonLabel="Nuevo Socio" icon="pi pi-user-plus" (actionClick)="openNewSocioModal()"></app-page-header>
<div class="card p-4 bg-white rounded-xl shadow-sm border border-gray-100 animate-fade-in">
	<!-- Tabla de Socios -->
	<div class="card">
		<p-table #dt [value]="socios" [paginator]="true" [rows]="5"
			[globalFilterFields]="['identificacion', 'nombres', 'apellidos', 'barrio', 'rol']" dataKey="id" rowHover
			selectionMode="single" [tableStyle]="{ 'min-width': '60rem' }">
			<!--  CAPTION (Buscador estilo PrimeNG) -->
			<ng-template pTemplate="caption">
				<p-iconfield iconPosition="left">
					<p-inputicon>
						<i class="pi pi-search"></i>
					</p-inputicon>
					<input pInputText type="text" (input)="dt.filterGlobal($event.target.value, 'contains')"
						placeholder="Buscar por nombre, c茅dula..." />
				</p-iconfield>
			</ng-template>

			<!-- П HEADER -->
			<ng-template pTemplate="header">
				<tr>
					<th pSortableColumn="identificacion" style="width: 20%">
						<div class="flex items-center gap-2">
							Identificaci贸n
							<p-sortIcon field="identificacion" />
						</div>
					</th>

					<th pSortableColumn="nombres" style="width: 25%">
						<div class="flex items-center gap-2">
							Nombre Completo
							<p-sortIcon field="nombres" />
						</div>
					</th>

					<th pSortableColumn="barrio" style="width: 20%">
						<div class="flex items-center gap-2">
							Barrio
							<p-sortIcon field="barrio" />
						</div>
					</th>

					<th pSortableColumn="rol" style="width: 15%">
						<div class="flex items-center gap-2">
							Rol
							<p-sortIcon field="rol" />
						</div>
					</th>

					<th pSortableColumn="esta_activo" style="width: 10%">
						<div class="flex items-center gap-2">
							Estado
							<p-sortIcon field="esta_activo" />
						</div>
					</th>

					<th style="width: 10%" class="text-center">Acciones</th>
				</tr>
			</ng-template>

			<!--  BODY -->
			<ng-template pTemplate="body" let-socio>
				<tr>
					<td>
						<div class="flex flex-col">
							<span class="font-bold text-gray-800">{{ socio.identificacion }}</span>
							<small class="text-xs text-gray-500">
								<span *ngIf="socio.tipo_identificacion === 'C'">C茅dula</span>
								<span *ngIf="socio.tipo_identificacion === 'R'">RUC</span>
								<span *ngIf="socio.tipo_identificacion === 'P'">Pasaporte</span>
							</small>
						</div>
					</td>

					<td>
						<div class="flex flex-col">
							<span class="font-medium"> {{ socio.nombres }} {{ socio.apellidos }} </span>
							<small class="text-gray-500">
								{{ socio.email || socio.telefono || 'Sin contacto' }}
							</small>
						</div>
					</td>

					<td>{{ getNombreBarrio(socio.barrio_id || socio.barrio) }}</td>

					<td>
						<p-tag [value]="socio.rol" [severity]="socio.rol === 'ADMINISTRADOR' ? 'danger' : 'info'" />
					</td>

					<td>
						<p-tag [value]="socio.esta_activo ? 'Activo' : 'Inactivo'"
							[severity]="socio.esta_activo ? 'success' : 'warn'" />
					</td>

					<td class="text-center">
						<div class="flex justify-center gap-2">
							<p-button icon="pi pi-eye" rounded text severity="info" (onClick)="verDetalle(socio.id)" />
							<p-button icon="pi pi-pencil" rounded text severity="warn"
								(onClick)="openEditSocioModal(socio)" />
							<p-button icon="pi pi-trash" rounded text severity="danger"
								(onClick)="deleteSocio(socio.id)" />
						</div>
					</td>
				</tr>
			</ng-template>

			<!--  EMPTY -->
			<ng-template pTemplate="emptymessage">
				<tr>
					<td colspan="6" class="text-center">No se encontraron socios.</td>
				</tr>
			</ng-template>
		</p-table>
	</div>
</div>

<!-- Modal de Registro/Edici贸n -->
<p-dialog [(visible)]="showSocioModal" [modal]="true" header="{{ isEditMode ? 'Editar Socio' : 'Registrar Socio' }}"
	[breakpoints]="{ '960px': '75vw', '640px': '95vw' }" [style]="{ width: '700px' }" styleClass="p-fluid"
	[draggable]="false" [resizable]="false" (onHide)="closeSocioModal()">
	<form [formGroup]="socioForm" (ngSubmit)="saveSocio()" class="flex flex-col gap-5 pt-2">
		<!-- Fila 1: Identificaci贸n Din谩mica -->
		<div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
			<!-- Tipo de Identificaci贸n -->
			<div class="flex flex-col gap-2">
				<span class="font-bold text-sm text-gray-700">Tipo de Documento</span>
				<p-select [options]="tipoIdentificacionOptions" formControlName="tipo_identificacion"
					optionLabel="label" optionValue="value" appendTo="body" styleClass="w-full"></p-select>
			</div>

			<!-- N煤mero de Identificaci贸n -->
			<div class="flex flex-col gap-2 sm:col-span-2">
				<span class="font-bold text-sm text-gray-700">N煤mero de Identificaci贸n *</span>
				<input pInputText id="identificacion" formControlName="identificacion"
					placeholder="Ingrese el n煤mero de documento" class="w-full"
					[ngClass]="{ 'ng-invalid ng-dirty': f['identificacion'].invalid && f['identificacion'].touched }" />
				<!-- Mensajes de Error Din谩micos -->
				<small *ngIf="f['identificacion'].invalid && f['identificacion'].touched" class="text-red-500 text-xs">
					{{ getIdentificacionError() }}
				</small>
			</div>
		</div>

		<!-- Fila 2: Nombres y Apellidos -->
		<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
			<div class="flex flex-col gap-2">
				<span class="font-bold text-sm text-gray-700">Nombres *</span>
				<input pInputText formControlName="nombres" placeholder="Ej: Juan Jos茅" class="w-full" />
				<small *ngIf="f['nombres'].invalid && f['nombres'].touched" class="text-red-500 text-xs">
					El nombre es obligatorio.
				</small>
			</div>
			<div class="flex flex-col gap-2">
				<span class="font-bold text-sm text-gray-700">Apellidos *</span>
				<input pInputText formControlName="apellidos" placeholder="Ej: P茅rez Garc铆a" class="w-full" />
				<small *ngIf="f['apellidos'].invalid && f['apellidos'].touched" class="text-red-500 text-xs">
					El apellido es obligatorio.
				</small>
			</div>
		</div>

		<!-- Fila 3: Barrio y Direcci贸n -->
		<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
			<div class="flex flex-col gap-2">
				<label for="barrio_id" class="font-bold text-sm text-gray-700">Barrio *</label>
				<p-select inputId="barrio_id" [options]="listaBarrios" formControlName="barrio_id" optionLabel="nombre"
					optionValue="id" placeholder="Seleccione un barrio" [showClear]="true" appendTo="body"
					styleClass="w-full" emptyMessage="No hay barrios registrados">
				</p-select>
				<small *ngIf="f['barrio_id'].invalid && f['barrio_id'].touched" class="text-red-500 text-xs">
					Dato obligatorio.
				</small>
			</div>

			<div class="flex flex-col gap-2">
				<label for="direccion" class="font-bold text-sm text-gray-700">Direcci贸n Exacta *</label>
				<input pInputText id="direccion" formControlName="direccion" placeholder="Ej: Calle Principal S/N"
					class="w-full" />
				<small *ngIf="f['direccion'].invalid && f['direccion'].touched" class="text-red-500 text-xs">
					La direcci贸n es obligatoria.
				</small>
			</div>
		</div>

		<!-- Fila 4: Contacto (Opcional) -->
		<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
			<div class="flex flex-col gap-2">
				<span class="font-bold text-sm text-gray-700">Email (Opcional)</span>
				<input pInputText formControlName="email" placeholder="Ej: juan@correo.com" class="w-full" />
				<small *ngIf="f['email'].invalid && f['email'].touched" class="text-red-500 text-xs">
					{{ f['email'].errors?.['email'] ? 'Formato de correo inv谩lido' : f['email'].errors?.['backend'] }}
				</small>
			</div>
			<div class="flex flex-col gap-2">
				<span class="font-bold text-sm text-gray-700">Tel茅fono (Opcional)</span>
				<input pInputText formControlName="telefono" placeholder="Ej: 0991234567" class="w-full" />
			</div>
		</div>

		<!-- Fila 5: Rol y Estado -->
		<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
			<div class="flex flex-col gap-2">
				<span class="font-bold text-sm text-gray-700">Rol del Usuario</span>
				<p-select formControlName="rol" [options]="rolesOptions" optionLabel="label" optionValue="value"
					placeholder="Seleccione rol" appendTo="body" styleClass="w-full"></p-select>
			</div>

			<div *ngIf="isEditMode" class="flex items-center gap-3 pb-2">
				<span class="font-bold text-sm text-gray-700">驴Socio Activo?</span>
				<p-toggleswitch formControlName="esta_activo"></p-toggleswitch>
			</div>
		</div>
	</form>

	<ng-template pTemplate="footer">
		<div class="flex justify-end gap-2 mt-4">
			<p-button label="Cancelar" icon="pi pi-times" [text]="true" severity="secondary"
				(onClick)="closeSocioModal()"></p-button>
			<p-button label="{{ isEditMode ? 'Actualizar' : 'Guardar' }}" icon="pi pi-check" (onClick)="saveSocio()"
				[disabled]="socioForm.invalid"></p-button>
		</div>
	</ng-template>
</p-dialog>