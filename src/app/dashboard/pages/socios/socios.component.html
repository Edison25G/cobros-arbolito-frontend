<p-toast></p-toast>
<p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>

<div class="card p-4 bg-white rounded-xl shadow-sm border border-gray-100 animate-fade-in">
	<!-- Encabezado y Buscador -->
	<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
		<div>
			<h2 class="text-2xl font-bold text-gray-800">Gesti√≥n de Socios</h2>
			<p class="text-sm text-gray-500">Administra el padr√≥n de usuarios y sus roles</p>
		</div>

		<div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
			<p-button
				label="Nuevo Socio"
				icon="pi pi-user-plus"
				(onClick)="openNewSocioModal()"
				styleClass="w-full sm:w-auto"
			></p-button>
		</div>
	</div>

	<!-- Tabla de Socios -->
	<div class="card">
		<p-table
			#dt
			[value]="socios"
			[loading]="isLoading"
			[paginator]="true"
			[rows]="5"
			[globalFilterFields]="['cedula', 'nombres', 'apellidos', 'barrio', 'rol']"
			dataKey="id"
			rowHover
			selectionMode="single"
			[tableStyle]="{ 'min-width': '60rem' }"
		>
			<!-- üîç CAPTION (Buscador estilo PrimeNG) -->
			<ng-template pTemplate="caption">
				<p-iconfield iconPosition="left">
					<p-inputicon>
						<i class="pi pi-search"></i>
					</p-inputicon>
					<input
						pInputText
						type="text"
						(input)="dt.filterGlobal($event.target.value, 'contains')"
						placeholder="Buscar socio..."
					/>
				</p-iconfield>
			</ng-template>

			<!-- üß± HEADER -->
			<ng-template pTemplate="header">
				<tr>
					<th pSortableColumn="cedula" style="width: 15%">
						<div class="flex items-center gap-2">
							C√©dula
							<p-sortIcon field="cedula" />
						</div>
					</th>

					<th pSortableColumn="nombres" style="width: 25%">
						<div class="flex items-center gap-2">
							Nombre Completo
							<p-sortIcon field="nombres" />
						</div>
					</th>

					<th pSortableColumn="barrio" style="width: 20%">
						<div class="flex items-center gap-2">
							Barrio
							<p-sortIcon field="barrio" />
						</div>
					</th>

					<th pSortableColumn="rol" style="width: 15%">
						<div class="flex items-center gap-2">
							Rol
							<p-sortIcon field="rol" />
						</div>
					</th>

					<th pSortableColumn="esta_activo" style="width: 10%">
						<div class="flex items-center gap-2">
							Estado
							<p-sortIcon field="esta_activo" />
						</div>
					</th>

					<th style="width: 15%" class="text-center">Acciones</th>
				</tr>
			</ng-template>

			<!-- üìÑ BODY -->
			<ng-template pTemplate="body" let-socio>
				<tr>
					<td>{{ socio.cedula }}</td>

					<td>
						<div class="flex flex-col">
							<span class="font-medium"> {{ socio.nombres }} {{ socio.apellidos }} </span>
							<small class="text-gray-500">
								{{ socio.email || socio.telefono || 'Sin contacto' }}
							</small>
						</div>
					</td>

					<td>{{ getNombreBarrio(socio.barrio) }}</td>

					<td>
						<p-tag [value]="socio.rol" [severity]="socio.rol === 'ADMINISTRADOR' ? 'danger' : 'info'" />
					</td>

					<td>
						<p-tag
							[value]="socio.esta_activo ? 'Activo' : 'Inactivo'"
							[severity]="socio.esta_activo ? 'success' : 'warn'"
						/>
					</td>

					<td class="text-center">
						<div class="flex justify-center gap-2">
							<p-button icon="pi pi-eye" rounded text severity="info" (onClick)="verDetalle(socio.id)" />

							<p-button icon="pi pi-pencil" rounded text severity="warn" (onClick)="openEditSocioModal(socio)" />

							<p-button icon="pi pi-trash" rounded text severity="danger" (onClick)="deleteSocio(socio.id)" />
						</div>
					</td>
				</tr>
			</ng-template>

			<!-- üö´ EMPTY -->
			<ng-template pTemplate="emptymessage">
				<tr>
					<td colspan="6" class="text-center">No se encontraron socios.</td>
				</tr>
			</ng-template>
		</p-table>
	</div>
</div>

<!-- Modal de Registro/Edici√≥n -->
<p-dialog
	[(visible)]="showSocioModal"
	[modal]="true"
	header="{{ isEditMode ? 'Editar Socio' : 'Registrar Socio' }}"
	[breakpoints]="{ '960px': '75vw', '640px': '95vw' }"
	[style]="{ width: '700px' }"
	styleClass="p-fluid"
	[draggable]="false"
	[resizable]="false"
	(onHide)="closeSocioModal()"
>
	<form [formGroup]="socioForm" (ngSubmit)="saveSocio()" class="flex flex-col gap-5 pt-2">
		<!-- Fila 1: C√©dula y Barrio -->
		<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
			<div class="flex flex-col gap-2">
				<span class="font-bold text-sm text-gray-700">C√©dula</span>
				<input
					pInputText
					formControlName="cedula"
					placeholder="Ej: 0501234567"
					class="w-full"
					[ngClass]="{ 'ng-invalid ng-dirty': f['cedula'].invalid && f['cedula'].touched }"
				/>
				<small *ngIf="f['cedula'].invalid && f['cedula'].touched" class="text-red-500 text-xs">
					C√©dula inv√°lida (10 d√≠gitos).
				</small>
			</div>

			<div class="flex flex-col gap-2">
				<label for="barrio_id" class="font-bold text-sm text-gray-700">Barrio *</label>
				<p-select
					[options]="listaBarrios"
					formControlName="barrio_id"
					optionLabel="nombre"
					optionValue="id"
					placeholder="Seleccione un barrio"
					[showClear]="true"
					appendTo="body"
					styleClass="w-full"
					emptyMessage="No hay barrios registrados"
				>
				</p-select>
				<small *ngIf="f['barrio_id'].invalid && f['barrio_id'].touched" class="text-red-500 text-xs">
					El barrio es obligatorio.
				</small>
			</div>

			<div class="flex flex-col gap-2">
				<label for="direccion" class="font-bold text-sm text-gray-700">Direcci√≥n Exacta *</label>
				<input pInputText formControlName="direccion" placeholder="Ej: Calle Principal S/N y Pasaje 2" class="w-full" />
				<small *ngIf="f['direccion'].invalid && f['direccion'].touched" class="text-red-500 text-xs">
					La direcci√≥n es obligatoria.
				</small>
			</div>
		</div>

		<!-- Fila 2: Nombres y Apellidos -->
		<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
			<div class="flex flex-col gap-2">
				<span class="font-bold text-sm text-gray-700">Nombres</span>
				<input pInputText formControlName="nombres" placeholder="Ej: Juan Jos√©" class="w-full" />
			</div>
			<div class="flex flex-col gap-2">
				<span class="font-bold text-sm text-gray-700">Apellidos</span>
				<input pInputText formControlName="apellidos" placeholder="Ej: P√©rez Garc√≠a" class="w-full" />
			</div>
		</div>

		<!-- Fila 3: Email y Tel√©fono -->
		<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
			<div class="flex flex-col gap-2">
				<span class="font-bold text-sm text-gray-700">Email (Opcional)</span>
				<input pInputText formControlName="email" placeholder="Ej: juan@correo.com" class="w-full" />
			</div>
			<div class="flex flex-col gap-2">
				<span class="font-bold text-sm text-gray-700">Tel√©fono (Opcional)</span>
				<input pInputText formControlName="telefono" placeholder="Ej: 0991234567" class="w-full" />
			</div>
		</div>

		<!-- Fila 4: Rol y Estado -->
		<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end">
			<div class="flex flex-col gap-2">
				<span class="font-bold text-sm text-gray-700">Rol del Usuario</span>
				<p-select
					formControlName="rol"
					[options]="rolesOptions"
					optionLabel="label"
					optionValue="value"
					placeholder="Seleccione rol"
					appendTo="body"
					styleClass="w-full"
				></p-select>
			</div>

			<div *ngIf="isEditMode" class="flex items-center gap-3 pb-2">
				<span class="font-bold text-sm text-gray-700">¬øSocio Activo?</span>
				<p-toggleswitch formControlName="esta_activo"></p-toggleswitch>
			</div>
		</div>
	</form>

	<ng-template pTemplate="footer">
		<div class="flex justify-end gap-2 mt-4">
			<p-button
				label="Cancelar"
				icon="pi pi-times"
				[text]="true"
				severity="secondary"
				(onClick)="closeSocioModal()"
			></p-button>
			<p-button
				label="{{ isEditMode ? 'Actualizar' : 'Guardar' }}"
				icon="pi pi-check"
				(onClick)="saveSocio()"
				[loading]="isLoading"
				[disabled]="socioForm.invalid"
			></p-button>
		</div>
	</ng-template>
</p-dialog>
