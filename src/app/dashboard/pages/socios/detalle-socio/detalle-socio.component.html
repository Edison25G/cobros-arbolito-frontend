<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>
<div *ngIf="isLoading" class="card p-6 bg-white rounded-xl shadow-sm border border-gray-100 animate-pulse">
	<div class="flex gap-4 mb-6">
		<p-skeleton shape="circle" size="5rem"></p-skeleton>
		<div class="flex-1 space-y-2">
			<p-skeleton width="50%" height="2rem"></p-skeleton>
			<p-skeleton width="30%"></p-skeleton>
		</div>
	</div>
	<p-skeleton height="150px"></p-skeleton>
</div>

<div *ngIf="!isLoading && socio" class="card p-6 bg-white rounded-xl shadow-sm border border-gray-100 animate-fade-in">
	<div class="flex flex-col gap-6 mb-6">
		<!-- AVATAR + NOMBRE -->
		<div class="flex flex-col md:flex-row gap-6 items-start">
			<div class="flex-shrink-0">
				<p-avatar
					icon="pi pi-user"
					size="xlarge"
					shape="circle"
					styleClass="bg-green-100 text-green-700 w-24 h-24 text-4xl shadow-sm"
				></p-avatar>
			</div>

			<div class="flex-grow w-full">
				<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
					<div>
						<h1 class="text-3xl font-bold text-gray-800">{{ socio.nombres }} {{ socio.apellidos }}</h1>
						<div class="text-gray-500 text-lg flex items-center gap-2 mt-1">
							<i class="pi pi-id-card text-green-600"></i>
							<span class="font-medium">{{ socio.cedula }}</span>
						</div>
					</div>

					<p-tag
						[value]="socio.esta_activo ? 'ACTIVO' : 'INACTIVO'"
						[severity]="socio.esta_activo ? 'success' : 'danger'"
					></p-tag>
				</div>
			</div>
		</div>

		<!--  BARRIO / ROL / CONTACTO (DEBAJO DEL LOGO) -->
		<div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
			<div class="p-2 bg-gray-50 rounded-lg">
				<span class="block text-gray-500 font-medium mb-1">Barrio (Domicilio)</span>
				{{ getNombreBarrio($any(socio).barrio || socio.barrio_id) }}
			</div>

			<div class="p-2 bg-gray-50 rounded-lg">
				<span class="block text-gray-500 font-medium mb-1">Rol</span>
				<p-tag [value]="socio.rol" severity="info"></p-tag>
			</div>

			<div class="p-2 bg-gray-50 rounded-lg">
				<span class="block text-gray-500 font-medium mb-1">Contacto</span>
				<div class="font-semibold break-words">
					<div class="flex items-center gap-2"><i class="pi pi-envelope text-xs"></i> {{ socio.email || 'N/A' }}</div>
					<div class="flex items-center gap-2 mt-1">
						<i class="pi pi-phone text-xs"></i> {{ socio.telefono || 'N/A' }}
					</div>
				</div>
			</div>
		</div>
	</div>

	<p-divider></p-divider>

	<div class="mt-6 mb-8 animate-fade-in-up">
		<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
			<div>
				<h3 class="text-xl font-bold text-gray-800 m-0">Propiedades Registradas</h3>
				<p class="text-gray-500 text-sm">Administra los terrenos y medidores asignados a este socio.</p>
			</div>

			<p-button
				label="Agregar Terreno"
				icon="pi pi-plus"
				[rounded]="true"
				severity="primary"
				(onClick)="abrirModalTerreno()"
			>
			</p-button>
		</div>

		<div class="card bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
			<p-table [value]="terrenos" [tableStyle]="{ 'min-width': '50rem' }">
				<ng-template pTemplate="header">
					<tr>
						<th>Barrio / Sector</th>
						<th>Direcci贸n / Referencia</th>
						<th>Servicio (Medidor)</th>
						<th class="text-center">Acciones</th>
					</tr>
				</ng-template>

				<ng-template pTemplate="body" let-terreno>
					<tr>
						<td class="font-bold">
							{{ terreno.nombre_barrio || '---' }}
						</td>

						<td>{{ terreno.direccion }}</td>

						<td>
							<p-tag
								[severity]="terreno.tiene_medidor || terreno.codigo_medidor ? 'info' : 'warn'"
								[value]="
									terreno.tiene_medidor || terreno.codigo_medidor
										? ' Medidor: ' + terreno.codigo_medidor
										: ' Solo Cometida'
								"
								[rounded]="true"
							>
							</p-tag>
						</td>

						<td class="text-center">
							<div class="flex justify-center gap-2 min-w-[90px]">
								<p-button
									icon="pi pi-pencil"
									[rounded]="true"
									[outlined]="true"
									severity="info"
									size="small"
									pTooltip="Editar terreno"
									tooltipPosition="top"
									(onClick)="editarTerreno(terreno)"
								>
								</p-button>

								<p-button
									icon="pi pi-trash"
									severity="danger"
									[rounded]="true"
									[outlined]="true"
									size="small"
									pTooltip="Eliminar terreno"
									tooltipPosition="top"
									(onClick)="eliminarTerreno(terreno)"
								>
								</p-button>
							</div>
						</td>
					</tr>
				</ng-template>
				<ng-template pTemplate="emptymessage">
					<tr>
						<td colspan="4" class="text-center p-8">
							<div class="flex flex-col items-center justify-center text-gray-400">
								<i class="pi pi-home text-4xl mb-2"></i>
								<p>Este socio a煤n no tiene terrenos registrados.</p>
								<p class="text-sm">Haz clic en "Agregar Terreno" para registrar uno.</p>
							</div>
						</td>
					</tr>
				</ng-template>
			</p-table>
		</div>
	</div>

	<p-tabs value="0">
		<p-tablist>
			<p-tab value="0">Historial de Pagos</p-tab>
		</p-tablist>

		<p-tabpanels>
			<p-tabpanel value="0">
				<p-table [value]="historialPagos" styleClass="p-datatable-sm p-datatable-striped" [rowHover]="true">
					<ng-template pTemplate="header">
						<tr>
							<th>Concepto</th>
							<th>Mes</th>
							<th>Monto</th>
							<th>Estado</th>
							<th>Fecha</th>
						</tr>
					</ng-template>
					<ng-template pTemplate="body" let-pago>
						<tr>
							<td class="font-medium">Consumo Agua</td>
							<td>{{ pago.mes }}</td>
							<td class="font-bold text-gray-700">{{ pago.monto | currency }}</td>
							<td>
								<p-tag
									[value]="pago.estado"
									[severity]="pago.estado === 'PAGADO' ? 'success' : 'warn'"
									[rounded]="true"
								></p-tag>
							</td>
							<td class="text-sm text-gray-500">{{ pago.fecha_pago || '---' }}</td>
						</tr>
					</ng-template>
					<ng-template pTemplate="emptymessage">
						<tr>
							<td colspan="5" class="text-center p-4">Sin historial.</td>
						</tr>
					</ng-template>
				</p-table>
			</p-tabpanel>
		</p-tabpanels>
	</p-tabs>

	<div class="flex justify-end mt-6 pt-4 border-t border-gray-100">
		<p-button
			label="Volver"
			icon="pi pi-arrow-left"
			[outlined]="true"
			severity="secondary"
			(onClick)="volver()"
		></p-button>
	</div>
</div>

<p-dialog
	[header]="esEdicion ? 'Editar Propiedad' : 'Registrar Nuevo Terreno'"
	[(visible)]="mostrarModalTerreno"
	[modal]="true"
	[style]="{ width: '450px' }"
	[draggable]="false"
	[resizable]="false"
>
	<form [formGroup]="terrenoForm" class="flex flex-col gap-4 mt-2">
		<div class="field flex flex-col gap-2">
			<span class="font-bold text-sm">Barrio / Sector *</span>
			<p-select
				[options]="listaBarrios"
				formControlName="barrio"
				optionLabel="nombre"
				optionValue="id"
				placeholder="Seleccione el sector"
				appendTo="body"
				[style]="{ width: '100%' }"
				[showClear]="true"
				emptyMessage="No hay barrios activos"
			>
			</p-select>
			<small
				*ngIf="terrenoForm.get('barrio')?.invalid && terrenoForm.get('barrio')?.touched"
				class="text-red-500 text-xs"
			>
				El barrio es obligatorio.
			</small>
		</div>

		<div class="field flex flex-col gap-2">
			<span class="font-bold text-sm">Direcci贸n / Referencia *</span>
			<input pInputText formControlName="direccion" placeholder="Ej: Frente a la escuela, casa verde" class="w-full" />
			<small
				*ngIf="terrenoForm.get('direccion')?.invalid && terrenoForm.get('direccion')?.touched"
				class="text-red-500 text-xs"
			>
				La direcci贸n es obligatoria.
			</small>
		</div>

		<div class="field flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-200">
			<div class="flex flex-col">
				<span class="font-bold text-sm text-gray-800">驴Tiene Medidor?</span>
				<span class="text-xs text-gray-500">Activar si el terreno posee medidor de agua.</span>
			</div>
			<p-toggleswitch formControlName="tiene_medidor"></p-toggleswitch>
		</div>

		<div *ngIf="terrenoForm.get('tiene_medidor')?.value" class="field flex flex-col gap-2 animate-fade-in">
			<span class="font-bold text-sm text-blue-700">C贸digo del Medidor *</span>
			<input pInputText formControlName="codigo_medidor" placeholder="Ej: MED-2024-001" class="w-full" />
			<small
				*ngIf="terrenoForm.get('codigo_medidor')?.invalid && terrenoForm.get('codigo_medidor')?.touched"
				class="text-red-500 text-xs"
			>
				El c贸digo es obligatorio si hay medidor.
			</small>
		</div>
	</form>

	<ng-template pTemplate="footer">
		<p-button label="Cancelar" icon="pi pi-times" [text]="true" (onClick)="mostrarModalTerreno = false"></p-button>
		<p-button label="Guardar Propiedad" icon="pi pi-check" [loading]="false" (onClick)="guardarTerreno()"></p-button>
	</ng-template>
</p-dialog>
