<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div *ngIf="isLoading" class="p-4 h-full flex flex-col gap-4 animate-pulse">
	<div class="flex gap-4">
		<p-skeleton shape="circle" size="4rem"></p-skeleton>
		<div class="flex-1 space-y-2">
			<p-skeleton width="40%" height="2rem"></p-skeleton>
			<p-skeleton width="20%"></p-skeleton>
		</div>
	</div>
	<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 h-full">
		<p-skeleton height="100%" styleClass="lg:col-span-1"></p-skeleton>
		<p-skeleton height="100%" styleClass="lg:col-span-2"></p-skeleton>
	</div>
</div>

<div *ngIf="!isLoading && socio" class="flex flex-col h-[calc(100vh-10rem)] p-2 gap-3 animate-fade-in">
	<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-3 flex justify-between items-center shrink-0">
		<div class="flex items-center gap-4">
			<p-avatar icon="pi pi-user" size="large" shape="circle" styleClass="bg-green-100 text-green-700"></p-avatar>
			<div>
				<h1 class="text-xl font-bold text-gray-800 m-0 leading-tight">{{ socio.nombres }} {{ socio.apellidos }}</h1>
				<div class="text-sm text-gray-500 flex items-center gap-2">
					<i class="pi pi-id-card text-green-600"></i>
					<span>{{ socio.identificacion }}</span>
					<p-tag
						[value]="socio.esta_activo ? 'ACTIVO' : 'INACTIVO'"
						[severity]="socio.esta_activo ? 'success' : 'danger'"
						styleClass="text-[10px] py-0 px-2 h-5"
					>
					</p-tag>
				</div>
			</div>
		</div>
		<p-button
			label="Volver"
			icon="pi pi-arrow-left"
			[outlined]="true"
			severity="secondary"
			size="small"
			(onClick)="volver()"
		></p-button>
	</div>

	<div class="grid grid-cols-1 lg:grid-cols-12 gap-3 flex-grow h-full">
		<div class="lg:col-span-4 flex flex-col gap-3 h-full">
			<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 shrink-0">
				<h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Informaci贸n General</h3>
				<div class="space-y-3 text-sm">
					<div class="flex justify-between border-b border-gray-50 pb-2">
						<span class="text-gray-500">Barrio:</span>
						<span class="font-medium text-right">{{ getNombreBarrio($any(socio).barrio || socio.barrio_id) }}</span>
					</div>
					<div class="flex justify-between border-b border-gray-50 pb-2">
						<span class="text-gray-500">Rol:</span>
						<p-tag [value]="socio.rol" severity="info" styleClass="text-[10px]"></p-tag>
					</div>
					<div class="flex flex-col gap-1">
						<span class="text-gray-500">Contacto:</span>
						<div class="flex items-center gap-2 text-gray-700">
							<i class="pi pi-envelope text-xs"></i> {{ socio.email || 'N/A' }}
						</div>
						<div class="flex items-center gap-2 text-gray-700">
							<i class="pi pi-phone text-xs"></i> {{ socio.telefono || 'N/A' }}
						</div>
					</div>
				</div>
			</div>

			<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 flex-grow flex flex-col justify-between">
				<div class="flex justify-between items-center mb-2 shrink-0">
					<h3 class="text-sm font-bold text-gray-800"><i class="pi pi-home mr-1"></i> Propiedades</h3>
					<p-button
						icon="pi pi-plus"
						[rounded]="true"
						[text]="true"
						severity="primary"
						size="small"
						pTooltip="Agregar"
						(onClick)="abrirModalTerreno()"
					></p-button>
				</div>

				<p-table
					[value]="terrenos"
					[rows]="2"
					[paginator]="true"
					styleClass="p-datatable-sm text-xs"
					responsiveLayout="scroll"
				>
					<ng-template pTemplate="header">
						<tr>
							<th>Direcci贸n / Medidor</th>
							<th class="w-16"></th>
						</tr>
					</ng-template>
					<ng-template pTemplate="body" let-terreno>
						<tr>
							<td>
								<div class="font-bold text-gray-700">{{ terreno.nombre_barrio || 'Sector' }}</div>
								<div class="text-gray-500">{{ terreno.direccion }}</div>
								<div class="mt-1">
									<span
										*ngIf="terreno.tiene_medidor || terreno.codigo_medidor"
										class="text-blue-600 bg-blue-50 px-1 rounded text-[10px]"
									>
										 {{ terreno.codigo_medidor }}
									</span>
									<span
										*ngIf="!terreno.tiene_medidor && !terreno.codigo_medidor"
										class="text-orange-600 bg-orange-50 px-1 rounded text-[10px]"
									>
										 Solo Cometida
									</span>
								</div>
							</td>
							<td class="text-right">
								<div class="flex flex-col gap-1">
									<p-button
										icon="pi pi-pencil"
										[text]="true"
										severity="info"
										size="small"
										(onClick)="editarTerreno(terreno)"
									></p-button>
									<p-button
										icon="pi pi-trash"
										[text]="true"
										severity="danger"
										size="small"
										(onClick)="eliminarTerreno(terreno)"
									></p-button>
								</div>
							</td>
						</tr>
					</ng-template>
					<ng-template pTemplate="emptymessage">
						<tr>
							<td colspan="2" class="text-center p-4 text-gray-400">Sin propiedades.</td>
						</tr>
					</ng-template>
				</p-table>
			</div>
		</div>

		<div class="lg:col-span-8 h-full">
			<div class="bg-white rounded-xl shadow-sm border border-gray-100 h-full flex flex-col">
				<div class="p-4 border-b border-gray-100 flex justify-between items-center shrink-0">
					<h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
						<i class="pi pi-history text-green-600"></i> Historial de Facturaci贸n
					</h3>
					<div class="flex items-center gap-2">
						<i class="pi pi-search text-gray-500 text-sm"></i>

						<input
							pInputText
							type="text"
							(input)="dtPagos.filterGlobal($any($event.target).value, 'contains')"
							placeholder="Buscar..."
							class="p-inputtext-sm w-32"
						/>
					</div>
				</div>

				<div class="flex-grow p-2 flex flex-col justify-center">
					<p-table
						#dtPagos
						[value]="historialPagos"
						[rows]="6"
						[paginator]="true"
						[globalFilterFields]="['fecha_emision', 'total', 'estado_pago']"
						styleClass="p-datatable-sm p-datatable-striped"
						[tableStyle]="{ 'min-width': '100%' }"
					>
						<ng-template pTemplate="header">
							<tr>
								<th class="text-xs font-bold text-gray-500 uppercase">Emisi贸n</th>
								<th class="text-xs font-bold text-gray-500 uppercase">Concepto</th>
								<th class="text-xs font-bold text-gray-500 uppercase text-right">Monto</th>
								<th class="text-xs font-bold text-gray-500 uppercase text-center">Estado</th>
								<th class="text-xs font-bold text-gray-500 uppercase text-center">Acci贸n</th>
							</tr>
						</ng-template>
						<ng-template pTemplate="body" let-pago>
							<tr class="hover:bg-gray-50 transition-colors">
								<td class="font-medium text-gray-700">
									{{ pago.fecha_emision | date: 'MMM yyyy' | uppercase }}
									<div class="text-[10px] text-gray-400">{{ pago.fecha_emision | date: 'dd/MM/yyyy' }}</div>
								</td>
								<td class="text-sm">Consumo Agua Potable</td>
								<td class="text-right font-bold text-gray-800">{{ pago.total | currency }}</td>
								<td class="text-center flex flex-col gap-1 items-center justify-center">
									<!-- Estado de Cobro (Financiero) -->
									<p-tag
										[value]="pago.estado_financiero || pago.estado || pago.estado_pago"
										[severity]="
											(pago.estado_financiero || pago.estado || pago.estado_pago) === 'PAGADA'
												? 'success'
												: (pago.estado_financiero || pago.estado || pago.estado_pago) === 'POR_VALIDAR'
													? 'info'
													: 'warn'
										"
										[rounded]="true"
										styleClass="text-[10px] px-2 uppercase font-bold"
									></p-tag>

									<!-- Estado SRI (Tributario) -->
									<p-tag
										*ngIf="pago.estado_sri"
										[value]="pago.estado_sri"
										[severity]="
											pago.estado_sri === 'AUTORIZADA'
												? 'success'
												: pago.estado_sri === 'PENDIENTE_SRI' ||
													  pago.estado_sri === 'DEVUELTA' ||
													  pago.estado_sri === 'NO_ENCONTRADO'
													? 'warn'
													: pago.estado_sri === 'PENDIENTE_FIRMA'
														? 'info'
														: pago.estado_sri === 'NO_ENVIADA'
															? 'secondary'
															: 'danger'
										"
										[icon]="
											pago.estado_sri === 'PENDIENTE_SRI' || pago.estado_sri === 'NO_ENCONTRADO'
												? 'pi pi-clock'
												: pago.estado_sri === 'AUTORIZADA'
													? 'pi pi-check-circle'
													: pago.estado_sri === 'DEVUELTA' ||
														  pago.estado_sri === 'RECHAZADA' ||
														  pago.estado_sri === 'ERROR'
														? 'pi pi-exclamation-triangle'
														: ''
										"
										[rounded]="true"
										styleClass="text-[9px] px-2 font-bold opacity-80"
										[pTooltip]="
											pago.estado_sri === 'DEVUELTA' || pago.estado_sri === 'RECHAZADA' || pago.estado_sri === 'ERROR'
												? pago.sri_mensaje_error || pago.mensaje_error_sri || 'Haz clic en Gesti贸n SRI para sincronizar'
												: pago.estado_sri === 'NO_ENCONTRADO'
													? 'SRI procesando internamente (Reintento autom谩tico)'
													: 'Estado en el SRI'
										"
										tooltipPosition="top"
									></p-tag>
								</td>
								<td class="text-center">
									<!-- Bot贸n PDF solo si el SRI autoriz贸 -->
									<p-button
										*ngIf="
											((pago.estado_financiero || pago.estado) === 'PAGADA' || pago.estado_pago === 'PAGADA') &&
											pago.estado_sri === 'AUTORIZADA'
										"
										icon="pi pi-file-pdf"
										[rounded]="true"
										[text]="true"
										severity="success"
										pTooltip="Imprimir Comprobante"
										tooltipPosition="left"
										(onClick)="imprimirFacturaSocio(pago)"
									></p-button>

									<!-- Pendiente de Pago -->
									<span
										*ngIf="(pago.estado_financiero || pago.estado) === 'PENDIENTE'"
										class="text-orange-400 text-xs font-medium"
										pTooltip="Pago Requerido"
										><i class="pi pi-clock"></i
									></span>
								</td>
							</tr>
						</ng-template>
						<ng-template pTemplate="emptymessage">
							<tr>
								<td colspan="5" class="text-center p-8 text-gray-400">No hay registros de facturas.</td>
							</tr>
						</ng-template>
					</p-table>
				</div>
			</div>
		</div>
	</div>
</div>

<p-dialog
	[header]="esEdicion ? 'Editar Propiedad' : 'Registrar Nuevo Terreno'"
	[(visible)]="mostrarModalTerreno"
	[modal]="true"
	[style]="{ width: '400px' }"
	[draggable]="false"
	[resizable]="false"
	styleClass="p-fluid"
>
	<form [formGroup]="terrenoForm" class="flex flex-col gap-4 mt-2">
		<div class="field flex flex-col gap-2">
			<span class="font-bold text-sm">Barrio / Sector *</span>
			<p-select
				[options]="listaBarrios"
				formControlName="barrio"
				optionLabel="nombre"
				optionValue="id"
				placeholder="Seleccione..."
				appendTo="body"
				[style]="{ width: '100%' }"
			></p-select>
		</div>
		<div class="field flex flex-col gap-2">
			<span class="font-bold text-sm">Direcci贸n *</span>
			<input pInputText formControlName="direccion" class="w-full" />
		</div>
		<div class="field flex items-center justify-between bg-gray-50 p-3 rounded border border-gray-200">
			<span class="font-bold text-sm">驴Tiene Medidor?</span>
			<p-toggleswitch formControlName="tiene_medidor"></p-toggleswitch>
		</div>

		<div *ngIf="terrenoForm.get('tiene_medidor')?.value" class="field flex flex-col gap-2">
			<span class="font-bold text-sm text-blue-700">C贸digo Secuencial *</span>
			<div class="p-inputgroup">
				<span class="p-inputgroup-addon font-bold text-gray-600 bg-gray-100 text-xs sm:text-sm">
					MED-{{ anioActual }}-
				</span>
				<input
					type="text"
					pInputText
					formControlName="codigo_medidor"
					placeholder="Ej: 001"
					maxlength="4"
					class="w-full"
				/>
			</div>
			<small class="text-gray-500 text-xs"
				>Ingrese solo el n煤mero. El sistema agregar谩 los ceros autom谩ticamente.</small
			>
		</div>
	</form>
	<ng-template pTemplate="footer">
		<p-button label="Cancelar" icon="pi pi-times" [text]="true" (onClick)="mostrarModalTerreno = false"></p-button>
		<p-button label="Guardar" icon="pi pi-check" (onClick)="guardarTerreno()"></p-button>
	</ng-template>
</p-dialog>
