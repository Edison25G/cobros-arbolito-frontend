<p-toast></p-toast>

<div class="p-2 sm:p-6 animate-fade-in min-h-[85vh]">
	<div
		class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100"
	>
		<div>
			<h2 class="text-2xl font-extrabold text-gray-800 m-0">Generar Emisión Mensual</h2>
			<p class="text-sm text-gray-500">Procesamiento de lecturas y cálculo de valores a pagar</p>
		</div>

		<div class="flex items-center gap-3 w-full md:w-auto bg-gray-50 p-2 rounded-lg border border-gray-200">
			<div class="flex flex-col">
				<span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">Mes de Emisión</span>
				<p-datepicker
					[(ngModel)]="fechaEmision"
					dateFormat="dd/mm/yy"
					appendTo="body"
					[showIcon]="true"
					(onSelect)="buscarPendientes()"
					styleClass="w-full border-0"
					inputStyleClass="bg-transparent border-none font-bold text-gray-700 w-full md:w-32 text-sm focus:ring-0"
				>
				</p-datepicker>
			</div>
			<i class="pi pi-calendar text-blue-400 text-xl mr-2"></i>
		</div>
	</div>

	<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
		<div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500 flex flex-col justify-center">
			<span class="text-gray-500 text-xs uppercase font-bold">Total Facturas</span>
			<span class="text-3xl font-bold text-gray-800">{{ totalPlanillas }}</span>
		</div>

		<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center">
			<span class="text-gray-500 text-xs uppercase font-bold">Por Consumo Agua</span>
			<span class="text-2xl font-bold text-blue-600">{{ totalAgua | currency }}</span>
		</div>

		<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center">
			<span class="text-gray-500 text-xs uppercase font-bold">Por Multas / Mingas</span>
			<span class="text-2xl font-bold text-orange-500">{{ totalMultas | currency }}</span>
		</div>

		<div class="bg-gray-800 p-4 rounded-xl shadow-lg flex flex-col justify-center relative overflow-hidden">
			<div class="absolute right-[-10px] top-[-10px] opacity-10">
				<i class="pi pi-dollar text-9xl text-white"></i>
			</div>
			<span class="text-gray-300 text-xs uppercase font-bold relative z-10">Total a Recaudar</span>
			<span class="text-3xl font-bold text-green-400 relative z-10">{{ granTotal | currency }}</span>
		</div>
	</div>

	<div class="mb-4 flex justify-end" *ngIf="totalPlanillas > 0">
		<p-button
			label="Confirmar y Generar Emisión"
			icon="pi pi-check-circle"
			[loading]="isProcessing"
			(onClick)="generarEmisionMasiva()"
			styleClass="p-button-lg bg-green-600 border-green-600 hover:bg-green-700 shadow-lg font-bold px-6"
		>
		</p-button>
	</div>

	<div class="card bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
		<div class="p-4 border-b border-gray-100 bg-gray-50/50">
			<h3 class="text-sm font-bold text-gray-700 m-0">Detalle de valores a generar (Pre-visualización)</h3>
		</div>

		<p-table
			[value]="lecturasPendientes"
			[loading]="isLoading"
			styleClass="p-datatable-sm p-datatable-striped"
			responsiveLayout="scroll"
		>
			<ng-template pTemplate="header">
				<tr class="bg-gray-50 text-xs uppercase tracking-wider text-gray-600">
					<th style="min-width: 200px">Socio</th>
					<th>Consumo</th>
					<th class="text-right">Servicio Agua</th>
					<th class="text-right">Multas Mingas</th>
					<th class="text-right font-bold text-gray-800 bg-gray-50">Total</th>
				</tr>
			</ng-template>

			<ng-template pTemplate="body" let-item>
				<tr>
					<td>
						<div class="font-bold text-gray-800">{{ item.socio_nombre }}</div>
						<div class="text-xs text-gray-400 flex items-center gap-2">
							<span>{{ item.cedula }}</span>

							<span
								*ngIf="item.medidor_codigo"
								class="bg-blue-50 text-blue-700 border border-blue-100 px-1 rounded text-[10px] font-mono"
							>
								{{ item.medidor_codigo }}
							</span>

							<span
								*ngIf="!item.medidor_codigo"
								class="bg-orange-50 text-orange-600 border border-orange-100 px-1 rounded text-[10px]"
							>
								Sin Medidor
							</span>
						</div>
					</td>

					<td>
						<div *ngIf="item.medidor_codigo; else sinMedidorTpl" class="flex flex-col">
							<span class="font-bold text-blue-700">{{ item.consumo }} m³</span>
							<span class="text-[10px] text-gray-400"> {{ item.lectura_anterior }} ➔ {{ item.lectura_actual }} </span>
						</div>

						<ng-template #sinMedidorTpl>
							<div class="flex flex-col">
								<span class="font-bold text-gray-500 text-xs uppercase">Tarifa Fija</span>
								<span class="text-[10px] text-orange-400 font-medium">Cobro Básico</span>
							</div>
						</ng-template>
					</td>

					<td class="text-right font-medium text-gray-600">
						{{ item.monto_agua | currency }}
					</td>

					<td class="text-right">
						<span
							*ngIf="item.multas_mingas > 0"
							class="text-orange-600 font-bold"
							[pTooltip]="item.detalle_multas?.join(', ')"
						>
							{{ item.multas_mingas | currency }}
							<i class="pi pi-info-circle text-[10px] ml-1"></i>
						</span>
						<span *ngIf="item.multas_mingas === 0" class="text-gray-300">-</span>
					</td>

					<td class="text-right font-bold text-lg text-green-700 bg-green-50/30">
						{{ item.total_pagar | currency }}
					</td>
				</tr>
			</ng-template>

			<ng-template pTemplate="emptymessage">
				<tr>
					<td colspan="5" class="text-center p-12 text-gray-400">
						<div class="flex flex-col items-center">
							<div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-3">
								<i class="pi pi-file text-2xl text-gray-300"></i>
							</div>
							<p class="font-medium text-gray-600">Todo al día</p>
							<p class="text-sm">No se encontraron lecturas pendientes para facturar en este mes.</p>
						</div>
					</td>
				</tr>
			</ng-template>
		</p-table>
	</div>
</div>
