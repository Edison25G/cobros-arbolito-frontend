<p-toast></p-toast>

<div class="p-2 sm:p-6 animate-fade-in min-h-[85vh]">
	<div
		class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100"
	>
		<div>
			<h2 class="text-2xl font-extrabold text-gray-800 m-0">Generar Planillas de Cobro</h2>
			<p class="text-sm text-gray-500">
				<span class="font-bold text-blue-600">Medidores</span> (Según Lectura) +
				<span class="font-bold text-orange-500">Acometidas</span> (Tarifa Fija)
			</p>
		</div>

		<div class="flex items-center gap-3 w-full md:w-auto bg-gray-50 p-2 rounded-lg border border-gray-200">
			<div class="flex flex-col">
				<span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider">Mes de Emisión</span>
				<p-datepicker
					[(ngModel)]="fechaEmision"
					dateFormat="dd/mm/yy"
					appendTo="body"
					[showIcon]="true"
					(onSelect)="buscarPreEmision()"
					styleClass="w-full border-0"
					inputStyleClass="bg-transparent border-none font-bold text-gray-700 w-full md:w-32 text-sm focus:ring-0"
				>
				</p-datepicker>
			</div>
		</div>
	</div>

	<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
		<div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500 flex flex-col justify-center">
			<span class="text-gray-500 text-xs uppercase font-bold">Medidores (Variable)</span>
			<div class="flex items-baseline gap-2">
				<span class="text-2xl font-bold text-gray-800">{{ totalPlanillasMedidor }}</span>
				<span class="text-xs text-gray-400">facturas</span>
			</div>
			<span class="text-sm font-bold text-blue-600 mt-1">{{ totalAgua | currency }}</span>
		</div>

		<div class="bg-orange-50 p-4 rounded-xl shadow-sm border border-orange-100 flex flex-col justify-center relative">
			<span class="text-orange-600 text-xs uppercase font-bold">Acometidas (Fijo $5)</span>
			<div class="flex items-center gap-2 mt-1">
				<i class="pi pi-cog animate-spin text-orange-400"></i>
				<span class="text-sm font-medium text-orange-800">Proceso Automático</span>
			</div>
			<p class="text-[10px] text-orange-600 mt-1 leading-tight">
				Se generarán automáticamente para socios sin medidor.
			</p>
		</div>

		<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center">
			<span class="text-gray-500 text-xs uppercase font-bold">Multas / Mingas</span>
			<span class="text-2xl font-bold text-red-500">{{ totalMultas | currency }}</span>
		</div>

		<div class="bg-gray-800 p-4 rounded-xl shadow-lg flex flex-col justify-center relative overflow-hidden">
			<div class="absolute right-[-10px] top-[-10px] opacity-10">
				<i class="pi pi-wallet text-9xl text-white"></i>
			</div>
			<span class="text-gray-300 text-xs uppercase font-bold relative z-10">Recaudación Medidores</span>
			<span class="text-3xl font-bold text-green-400 relative z-10">{{ granTotal | currency }}</span>
			<span class="text-[10px] text-gray-400 relative z-10 mt-1">+ Acometidas Fijas</span>
		</div>
	</div>

	<div class="mb-4 flex justify-end">
		<p-button
			label="Confirmar y Generar Todo"
			icon="pi pi-check-circle"
			[loading]="isProcessing"
			(onClick)="generarEmisionMasiva()"
			styleClass="p-button-lg bg-green-600 border-green-600 hover:bg-green-700 shadow-lg font-bold px-6"
		>
		</p-button>
	</div>

	<div class="card bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
		<div class="p-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
			<h3 class="text-sm font-bold text-gray-700 m-0">Detalle de Consumos (Solo Medidores)</h3>
			<span class="text-xs text-gray-400 bg-white px-2 py-1 rounded border border-gray-200">
				<i class="pi pi-info-circle mr-1"></i> Las tarifas fijas no aparecen en esta lista previa.
			</span>
		</div>

		<p-table
			[value]="lecturasPendientes"
			[loading]="isLoading"
			styleClass="p-datatable-sm p-datatable-striped"
			responsiveLayout="scroll"
			[paginator]="true"
			[rows]="10"
		>
			<ng-template pTemplate="header">
				<tr class="bg-gray-50 text-xs uppercase tracking-wider text-gray-600">
					<th style="min-width: 200px">Socio</th>
					<th>Lectura</th>
					<th class="text-right">Consumo</th>
					<th class="text-right">Valor Agua</th>
					<th class="text-right">Multas</th>
					<th class="text-right font-bold text-gray-800 bg-gray-50">Subtotal</th>
				</tr>
			</ng-template>

			<ng-template pTemplate="body" let-item>
				<tr>
					<td>
						<div class="font-bold text-gray-800">{{ item.socio_nombre }}</div>
						<div class="text-xs text-gray-400 flex items-center gap-2">
							<span>{{ item.cedula }}</span>
							<span class="bg-blue-50 text-blue-700 border border-blue-100 px-1 rounded text-[10px] font-mono">
								{{ item.medidor_codigo }}
							</span>
						</div>
					</td>

					<td>
						<div class="text-xs text-gray-500">
							{{ item.lectura_anterior }} ➔ <span class="font-bold text-gray-800">{{ item.lectura_actual }}</span>
						</div>
					</td>

					<td class="text-right font-bold text-blue-600">{{ item.consumo }} m³</td>

					<td class="text-right text-gray-600">
						{{ item.monto_agua | currency }}
					</td>

					<td class="text-right text-orange-600">
						{{ item.multas_mingas > 0 ? (item.multas_mingas | currency) : '-' }}
					</td>

					<td class="text-right font-bold text-green-700 bg-green-50/30">
						{{ item.total_pagar | currency }}
					</td>
				</tr>
			</ng-template>

			<ng-template pTemplate="emptymessage">
				<tr>
					<td colspan="6" class="text-center p-12 text-gray-400">
						<div class="flex flex-col items-center">
							<i class="pi pi-file text-4xl text-gray-200 mb-2"></i>
							<p>No hay lecturas de medidores pendientes.</p>
							<p class="text-sm text-gray-400">
								Si solo tienes acometidas fijas, puedes generar la emisión directamente.
							</p>
						</div>
					</td>
				</tr>
			</ng-template>
		</p-table>
	</div>
</div>
