<p-toast></p-toast>
<p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>

<div class="card p-4 bg-white rounded-xl shadow-sm border border-gray-100 animate-fade-in">
	<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
		<div>
			<h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
				<i class="pi pi-exclamation-circle text-orange-500"></i>
				Gesti贸n de Multas
			</h2>
			<p class="text-sm text-gray-500">Administra las multas por inasistencia a mingas (Solo Administradores)</p>
		</div>
	</div>

	<div class="overflow-x-auto">
		<p-table
			[value]="multas"
			[loading]="loading"
			[rowHover]="true"
			styleClass="p-datatable-sm min-w-[700px]"
			[paginator]="true"
			[rows]="10"
		>
			<ng-template pTemplate="header">
				<tr>
					<th style="width: 20%">Socio</th>
					<th style="width: 25%">Minga</th>
					<th style="width: 12%">Fecha</th>
					<th style="width: 12%">Monto</th>
					<th style="width: 12%">Estado</th>
					<th class="text-center" style="width: 19%">Acciones</th>
				</tr>
			</ng-template>

			<ng-template pTemplate="body" let-multa>
				<tr>
					<td>
						<div class="font-bold text-gray-800">{{ multa.socio_nombre }}</div>
					</td>
					<td>
						<div class="text-gray-700">{{ multa.minga_titulo }}</div>
					</td>
					<td class="text-gray-500">{{ multa.fecha | date: 'dd/MM/yyyy' }}</td>
					<td class="font-semibold text-red-600">${{ multa.monto | number: '1.2-2' }}</td>
					<td>
						<p-tag [value]="multa.estado" [severity]="getSeverity(multa.estado)" [rounded]="true"></p-tag>
					</td>
					<td class="text-center">
						<div class="flex justify-center gap-2">
							<!-- Bot贸n Impugnar/Corregir (Solo para PENDIENTES y Admins) -->
							<p-button
								*ngIf="puedeImpugnar(multa)"
								icon="pi pi-pencil"
								label="Impugnar"
								severity="warn"
								[outlined]="true"
								size="small"
								pTooltip="Anular o Rectificar multa"
								tooltipPosition="top"
								(onClick)="abrirDialogImpugnar(multa)"
							>
							</p-button>

							<!-- Badge informativo si ya fue procesada -->
							<span *ngIf="multa.estado === 'ANULADA'" class="text-xs text-gray-400 italic">
								<i class="pi pi-ban mr-1"></i>Anulada
							</span>
							<span *ngIf="multa.estado === 'RECTIFICADA'" class="text-xs text-blue-400 italic">
								<i class="pi pi-check mr-1"></i>Rectificada
							</span>
							<span *ngIf="multa.estado === 'PAGADA'" class="text-xs text-green-500 italic">
								<i class="pi pi-dollar mr-1"></i>Cobrada
							</span>
						</div>
					</td>
				</tr>
			</ng-template>

			<ng-template pTemplate="emptymessage">
				<tr>
					<td colspan="6" class="text-center p-6 text-gray-500">
						<i class="pi pi-check-circle text-4xl text-green-300 mb-2"></i>
						<p>No hay multas registradas. 隆Todos asistieron! </p>
					</td>
				</tr>
			</ng-template>
		</p-table>
	</div>
</div>

<!-- DIALOG: Impugnar/Rectificar Multa -->
<p-dialog
	[(visible)]="dialogVisible"
	header="Impugnar Multa"
	[modal]="true"
	[breakpoints]="{ '960px': '75vw', '640px': '95vw' }"
	[style]="{ width: '450px' }"
	styleClass="p-fluid"
	[draggable]="false"
	[resizable]="false"
>
	<ng-template pTemplate="content">
		<div class="mb-4 p-3 bg-orange-50 border border-orange-200 rounded-lg" *ngIf="multaSeleccionada">
			<div class="text-sm text-gray-600"><strong>Socio:</strong> {{ multaSeleccionada.socio_nombre }}</div>
			<div class="text-sm text-gray-600"><strong>Minga:</strong> {{ multaSeleccionada.minga_titulo }}</div>
			<div class="text-sm text-gray-600">
				<strong>Monto Actual:</strong>
				<span class="text-red-600 font-bold">${{ multaSeleccionada.monto | number: '1.2-2' }}</span>
			</div>
		</div>

		<form [formGroup]="impugnarForm" class="flex flex-col gap-4">
			<!-- Acci贸n -->
			<div class="flex flex-col gap-2">
				<span class="font-bold text-sm text-gray-700">Acci贸n a Realizar</span>
				<p-select
					formControlName="accion"
					[options]="accionesOptions"
					optionLabel="label"
					optionValue="value"
					placeholder="Seleccione acci贸n"
					styleClass="w-full"
				></p-select>
			</div>

			<!-- Nuevo Monto (Solo si es RECTIFICAR) -->
			<div class="flex flex-col gap-2" *ngIf="impugnarForm.get('accion')?.value === 'RECTIFICAR'">
				<span class="font-bold text-sm text-gray-700">Nuevo Monto ($)</span>
				<p-inputNumber
					formControlName="nuevo_monto"
					mode="currency"
					currency="USD"
					locale="en-US"
					placeholder="Ej: 5.00"
					styleClass="w-full"
				></p-inputNumber>
				<small class="text-gray-400">Ingrese el monto corregido</small>
			</div>

			<!-- Motivo -->
			<div class="flex flex-col gap-2">
				<span class="font-bold text-sm text-gray-700">Motivo / Justificaci贸n</span>
				<textarea
					pInputTextarea
					formControlName="motivo"
					rows="3"
					placeholder="Ej: Error humano al tomar asistencia, el socio s铆 asisti贸..."
					class="w-full"
				></textarea>
				<small class="text-gray-400">Este motivo quedar谩 registrado para auditor铆a</small>
			</div>
		</form>
	</ng-template>

	<ng-template pTemplate="footer">
		<div class="flex justify-end gap-2 mt-2">
			<p-button
				label="Cancelar"
				icon="pi pi-times"
				[text]="true"
				severity="secondary"
				(onClick)="dialogVisible = false"
			></p-button>
			<p-button
				label="Confirmar"
				icon="pi pi-check"
				severity="warn"
				[loading]="procesando"
				[disabled]="impugnarForm.invalid"
				(onClick)="confirmarImpugnacion()"
			></p-button>
		</div>
	</ng-template>
</p-dialog>
