<p-toast position="bottom-right"></p-toast>
<p-confirmDialog [style]="{ width: '450px' }" styleClass="modern-confirm-dialog"></p-confirmDialog>

<div class="h-full flex flex-col p-4 md:p-6 bg-slate-50/50 animate-fade-in font-sans overflow-hidden">
	<div class="flex-none flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
		<div>
			<h2 class="text-2xl font-extrabold text-slate-800 tracking-tight flex items-center gap-2">
				<i class="pi pi-server text-emerald-500"></i>
				Inventario de Medidores
			</h2>
			<p class="text-slate-500 text-xs mt-1 ml-1">Control de activos y asignación técnica.</p>
		</div>

		<div class="flex gap-2">
			<div
				class="hidden md:flex items-center px-3 py-1.5 bg-white rounded-lg border border-slate-200 shadow-sm text-xs font-bold text-slate-600"
			>
				<span class="w-2 h-2 rounded-full bg-emerald-500 mr-2 animate-pulse"></span>
				{{ medidores.length }} Activos
			</div>

			<p-button
				icon="pi pi-refresh"
				class="!bg-white !text-slate-500 !border-slate-200 hover:!bg-slate-50 hover:!text-emerald-600 !rounded-lg !w-9 !h-9 !p-0 shadow-sm transition-all"
				(click)="loadMedidores()"
				pTooltip="Actualizar"
				tooltipPosition="left"
			></p-button>
		</div>
	</div>

	<div class="flex-1 min-h-0 bg-white rounded-xl shadow-xl border border-slate-100 flex flex-col overflow-hidden">
		<p-table
			#dt
			[value]="medidores"
			[paginator]="true"
			[rows]="5"
			[loading]="isLoading"
			[globalFilterFields]="['codigo', 'nombre_barrio', 'nombre_socio', 'estado']"
			styleClass="p-datatable-modern h-full"
			[rowHover]="true"
			[showCurrentPageReport]="true"
			currentPageReportTemplate="{first}-{last} de {totalRecords}"
			[scrollable]="true"
			scrollHeight="flex"
		>
			<ng-template pTemplate="caption">
				<div class="flex items-center gap-3 px-4 py-3 bg-slate-50/40 border-b border-slate-100">
					<div class="relative w-full max-w-md group">
						<i
							class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-emerald-500 transition-colors z-10 text-sm"
						></i>
						<input
							pInputText
							type="text"
							(input)="dt.filterGlobal($any($event.target).value, 'contains')"
							placeholder="Buscar serial, ubicación o socio..."
							class="pl-9 w-full bg-white border-slate-200 rounded-lg py-2 text-sm focus:ring-2 focus:ring-emerald-100 focus:border-emerald-500 transition-all shadow-sm"
						/>
					</div>
				</div>
			</ng-template>

			<ng-template pTemplate="header">
				<tr class="bg-slate-50 text-[11px] uppercase tracking-wider text-slate-500 font-bold border-b border-slate-100">
					<th pSortableColumn="codigo" class="py-3 pl-6" style="min-width: 180px">
						Dispositivo <p-sortIcon field="codigo"></p-sortIcon>
					</th>
					<th pSortableColumn="nombre_barrio" class="py-3" style="min-width: 150px">
						Ubicación <p-sortIcon field="nombre_barrio"></p-sortIcon>
					</th>
					<th pSortableColumn="nombre_socio" class="py-3" style="min-width: 200px">
						Asignado A <p-sortIcon field="nombre_socio"></p-sortIcon>
					</th>
					<th pSortableColumn="estado" class="py-3 text-center" style="min-width: 100px">
						Estado <p-sortIcon field="estado"></p-sortIcon>
					</th>
					<th class="py-3 text-center pr-4" style="min-width: 100px">Acciones</th>
				</tr>
			</ng-template>

			<ng-template pTemplate="body" let-item>
				<tr class="hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-0 group">
					<td class="pl-6 py-3">
						<div class="flex items-center gap-3">
							<div
								class="w-8 h-8 rounded-lg bg-slate-100 text-slate-500 flex items-center justify-center border border-slate-200 group-hover:border-emerald-200 group-hover:bg-emerald-50 group-hover:text-emerald-600 transition-colors"
							>
								<i class="pi pi-qrcode text-sm"></i>
							</div>
							<div class="flex flex-col">
								<span
									class="font-mono font-bold text-slate-700 text-xs tracking-wide group-hover:text-emerald-700 transition-colors"
								>
									{{ item.codigo }}
								</span>
								<span class="text-[9px] text-slate-400 font-bold uppercase tracking-wider" *ngIf="item.marca">
									{{ item.marca }}
								</span>
							</div>
						</div>
					</td>

					<td class="py-3">
						<div class="flex items-center gap-1.5">
							<i class="pi pi-map-marker text-emerald-400 text-xs"></i>
							<span class="text-xs font-semibold text-slate-600 truncate max-w-[150px]">
								{{ item.nombre_barrio || 'Sin Ubicación' }}
							</span>
						</div>
					</td>

					<td class="py-3">
						<div *ngIf="item.terreno_id" class="flex items-center gap-2">
							<div
								class="w-6 h-6 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center font-bold text-[10px] border border-indigo-100 shadow-sm"
							>
								{{ item.nombre_socio.charAt(0) }}
							</div>
							<div class="flex flex-col">
								<span class="text-xs font-bold text-slate-700 leading-tight truncate max-w-[180px]">
									{{ item.nombre_socio }}
								</span>
								<span class="text-[9px] text-slate-400 flex items-center gap-1">
									<span class="w-1 h-1 rounded-full bg-green-500"></span> En servicio
								</span>
							</div>
						</div>

						<div *ngIf="!item.terreno_id" class="flex items-center gap-2 opacity-60">
							<div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center border border-slate-200">
								<i class="pi pi-box text-slate-400 text-[10px]"></i>
							</div>
							<span class="text-xs text-slate-500 italic">En Bodega</span>
						</div>
					</td>

					<td class="text-center py-3">
						<span
							class="inline-flex items-center gap-1 px-2 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wide border shadow-sm"
							[ngClass]="{
								'bg-emerald-50 text-emerald-700 border-emerald-100': item.estado === 'ACTIVO',
								'bg-red-50 text-red-700 border-red-100': item.estado === 'DANADO',
								'bg-amber-50 text-amber-700 border-amber-100':
									item.estado === 'SUSPENDIDO' || item.estado === 'MANTENIMIENTO',
							}"
						>
							{{ item.estado }}
						</span>
					</td>

					<td class="text-center pr-4 py-3">
						<div class="flex justify-center items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
							<p-button
								icon="pi pi-cog"
								class="!p-0 !w-7 !h-7 !rounded-full !bg-transparent !text-slate-400 hover:!text-blue-600 hover:!bg-blue-50 transition-all"
								pTooltip="Gestionar"
								tooltipPosition="top"
								(click)="cambiarEstado(item)"
							></p-button>

							<p-button
								icon="pi pi-trash"
								class="!p-0 !w-7 !h-7 !rounded-full !bg-transparent !text-slate-400 hover:!text-red-600 hover:!bg-red-50 transition-all"
								pTooltip="Dar de Baja"
								tooltipPosition="top"
								(click)="deleteMedidor(item.id!)"
							></p-button>
						</div>
					</td>
				</tr>
			</ng-template>

			<ng-template pTemplate="emptymessage">
				<tr>
					<td colspan="5">
						<div class="flex flex-col items-center justify-center py-12 text-center h-full">
							<div
								class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-3 border border-slate-100 shadow-inner"
							>
								<i class="pi pi-server text-2xl text-slate-300"></i>
							</div>
							<h3 class="text-slate-800 font-bold text-sm">No se encontraron dispositivos</h3>
							<p class="text-slate-500 text-xs mt-1">No hay coincidencias con la búsqueda.</p>
						</div>
					</td>
				</tr>
			</ng-template>
		</p-table>
	</div>
</div>
