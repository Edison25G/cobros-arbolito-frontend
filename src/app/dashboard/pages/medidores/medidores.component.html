<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="p-2 sm:p-6 animate-fade-in min-h-[85vh]">
	<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
		<div>
			<h2 class="text-2xl font-extrabold text-gray-800 m-0">Inventario de Medidores</h2>
			<p class="text-sm text-gray-500">Gestión técnica de dispositivos instalados</p>
		</div>
	</div>

	<div class="card bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
		<p-table
			#dt
			[value]="medidores"
			[rows]="10"
			[paginator]="true"
			[loading]="isLoading"
			[globalFilterFields]="['codigo', 'estado', 'terreno_data.barrio_data.nombre', 'terreno_data.socio.nombres']"
			styleClass="p-datatable-sm p-datatable-striped"
			responsiveLayout="scroll"
		>
			<ng-template pTemplate="caption">
				<div class="flex flex-col sm:flex-row justify-between items-center gap-3">
					<span class="p-input-icon-left w-full sm:w-auto">
						<i class="pi pi-search"></i>
						<input
							pInputText
							type="text"
							(input)="filterGlobal($event, dt)"
							placeholder="Buscar código, barrio o socio..."
							class="w-full sm:w-80 pl-10"
						/>
					</span>

					<p-button
						icon="pi pi-refresh"
						[rounded]="true"
						[text]="true"
						severity="secondary"
						pTooltip="Recargar lista"
						(onClick)="loadMedidores()"
					>
					</p-button>
				</div>
			</ng-template>

			<ng-template pTemplate="header">
				<tr class="bg-gray-50 text-xs uppercase tracking-wider text-gray-600">
					<th pSortableColumn="codigo">Código <p-sortIcon field="codigo"></p-sortIcon></th>
					<th>Ubicación (Barrio)</th>
					<th>Socio Responsable</th>
					<th pSortableColumn="estado">Estado <p-sortIcon field="estado"></p-sortIcon></th>
					<th class="text-center">Acciones</th>
				</tr>
			</ng-template>

			<ng-template pTemplate="body" let-item>
				<tr>
					<td class="font-bold text-gray-800">{{ item.codigo }}</td>

					<td>
						<div class="flex items-center gap-2">
							<i class="pi pi-map-marker text-gray-400"></i>
							<span class="font-medium text-gray-700">
								{{ item.nombre_barrio || 'Sin Asignar' }}
							</span>
						</div>
						<div class="text-xs text-gray-400 pl-6" *ngIf="item.terreno_data">
							{{ item.terreno_data.direccion }}
						</div>
					</td>

					<td>
						<div *ngIf="item.terreno_id" class="flex flex-col">
							<span class="font-bold text-blue-800">
								{{ item.nombre_socio }}
							</span>
							<span class="text-xs text-green-600 flex items-center gap-1">
								<i class="pi pi-check-circle text-[10px]"></i> Instalado
							</span>
						</div>

						<div
							*ngIf="!item.terreno_id"
							class="flex items-center gap-2 text-gray-400 italic bg-gray-50 px-2 py-1 rounded-md border border-gray-100 w-fit"
						>
							<i class="pi pi-box"></i>
							<span>En bodega / Sin uso</span>
						</div>
					</td>

					<td>
						<p-tag
							[value]="item.estado"
							[severity]="item.estado === 'ACTIVO' ? 'success' : item.estado === 'DANADO' ? 'danger' : 'warn'"
							[rounded]="true"
						>
						</p-tag>
					</td>

					<td class="text-center">
						<div class="flex justify-center gap-2">
							<p-button
								icon="pi pi-cog"
								[rounded]="true"
								[text]="true"
								severity="secondary"
								pTooltip="Cambiar Estado"
								tooltipPosition="top"
								(onClick)="cambiarEstado(item)"
							>
							</p-button>

							<p-button
								icon="pi pi-trash"
								[rounded]="true"
								[text]="true"
								severity="danger"
								pTooltip="Eliminar del Inventario"
								tooltipPosition="top"
								(onClick)="deleteMedidor(item.id!)"
							>
							</p-button>
						</div>
					</td>
				</tr>
			</ng-template>

			<ng-template pTemplate="emptymessage">
				<tr>
					<td colspan="5" class="text-center p-8 text-gray-400">
						<div class="flex flex-col items-center">
							<i class="pi pi-inbox text-4xl mb-3 opacity-50"></i>
							<p>No hay medidores registrados en el inventario.</p>
						</div>
					</td>
				</tr>
			</ng-template>
		</p-table>
	</div>
</div>
