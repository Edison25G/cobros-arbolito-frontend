<p-toast></p-toast>
<p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>

<div class="card p-4 bg-white rounded-xl shadow-sm border border-gray-100 animate-fade-in">
	<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
		<div>
			<h2 class="text-2xl font-bold text-gray-800">Gestión de Eventos</h2>
			<p class="text-sm text-gray-500">Programa mingas, sesiones y gestiona la asistencia</p>
		</div>
		<p-button
			label="Nuevo Evento"
			icon="pi pi-calendar-plus"
			(onClick)="openNew()"
			styleClass="w-full sm:w-auto"
		></p-button>
	</div>

	<div class="overflow-x-auto">
		<p-table [value]="mingas" [loading]="loading" [rowHover]="true" styleClass="p-datatable-sm min-w-[600px]">
			<ng-template pTemplate="header">
				<tr>
					<th style="width: 15%">Fecha</th>
					<th style="width: 20%">Evento</th>
					<th style="width: 10%">Tipo</th>
					<th style="width: 20%">Lugar</th>
					<th style="width: 10%">Multa</th>
					<th style="width: 10%">Estado</th>
					<th class="text-center" style="width: 15%">Acciones</th>
				</tr>
			</ng-template>

			<ng-template pTemplate="body" let-minga>
				<tr>
					<td class="whitespace-nowrap">{{ minga.fecha | date: 'dd/MM/yyyy' }}</td>
					<td>
						<div class="font-bold text-gray-800">{{ minga.titulo }}</div>
						<div class="text-xs text-gray-500 truncate max-w-[150px]">{{ minga.descripcion }}</div>
					</td>
					<td>
						<p-tag
							[value]="minga.tipo || 'MINGA'"
							[severity]="minga.tipo === 'SESION' ? 'warn' : 'info'"
							styleClass="text-[10px]"
						></p-tag>
					</td>
					<td>{{ minga.lugar }}</td>
					<td class="font-semibold text-red-600">${{ minga.multa | number: '1.2-2' }}</td>
					<td>
						<p-tag
							[value]="minga.estado"
							[severity]="minga.estado === 'Realizada' ? 'success' : minga.estado === 'Programada' ? 'info' : 'danger'"
							[rounded]="true"
						></p-tag>
					</td>
					<td class="text-center">
						<div class="flex justify-center gap-2">
							<!-- Botón Asistencia -->
							<p-button
								*ngIf="minga.estado === 'Programada'"
								icon="pi pi-list-check"
								pTooltip="Tomar Asistencia"
								tooltipPosition="top"
								[rounded]="true"
								[outlined]="true"
								size="small"
								(onClick)="irAAsistencia(minga.id)"
							>
							</p-button>

							<!-- Botón Cerrar Evento -->
							<p-button
								*ngIf="minga.estado === 'Programada'"
								icon="pi pi-check-circle"
								pTooltip="Cerrar Evento (Generar Multas)"
								tooltipPosition="top"
								severity="success"
								[rounded]="true"
								[text]="true"
								(onClick)="cerrarEvento(minga)"
							></p-button>

							<p-button
								icon="pi pi-trash"
								severity="danger"
								[text]="true"
								[rounded]="true"
								(onClick)="eliminarEvento(minga)"
							></p-button>
						</div>
					</td>
				</tr>
			</ng-template>

			<ng-template pTemplate="emptymessage">
				<tr>
					<td colspan="7" class="text-center p-6 text-gray-500">No hay eventos registrados.</td>
				</tr>
			</ng-template>
		</p-table>
	</div>
</div>

<p-dialog
	[(visible)]="dialogVisible"
	header="Programar Nuevo Evento"
	[modal]="true"
	[breakpoints]="{ '960px': '75vw', '640px': '95vw' }"
	[style]="{ width: '550px' }"
	styleClass="p-fluid"
	[draggable]="false"
	[resizable]="false"
>
	<ng-template pTemplate="content">
		<form [formGroup]="mingaForm" class="flex flex-col gap-5 pt-2">
			<!-- Fila 1: Título y Tipo -->
			<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
				<div class="flex flex-col gap-2">
					<span class="font-bold text-sm text-gray-700">Título del Evento *</span>
					<input pInputText formControlName="titulo" placeholder="Ej: Asamblea General" class="w-full" />
				</div>
				<div class="flex flex-col gap-2">
					<span class="font-bold text-sm text-gray-700">Tipo de Evento *</span>
					<p-select
						[options]="tiposEvento"
						formControlName="tipo"
						optionLabel="label"
						optionValue="value"
						appendTo="body"
						styleClass="w-full"
					></p-select>
				</div>
			</div>

			<!-- Fila 2: Alcance y Barrio (Condicional) -->
			<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
				<div class="flex flex-col gap-2">
					<span class="font-bold text-sm text-gray-700">¿A quién aplica? *</span>
					<p-select
						[options]="opcionesSeleccion"
						formControlName="seleccion_socios"
						optionLabel="label"
						optionValue="value"
						appendTo="body"
						styleClass="w-full"
					></p-select>
				</div>
				<div *ngIf="mingaForm.get('seleccion_socios')?.value === 'BARRIO'" class="flex flex-col gap-2 animate-fade-in">
					<span class="font-bold text-sm text-gray-700">Seleccione Barrio *</span>
					<p-select
						[options]="barrios"
						formControlName="barrio_id"
						optionLabel="nombre"
						optionValue="id"
						placeholder="Seleccione..."
						appendTo="body"
						styleClass="w-full"
					></p-select>
				</div>
			</div>

			<!-- Fila 3: Fecha y Multa -->
			<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
				<div class="flex flex-col gap-2">
					<span class="font-bold text-sm text-gray-700">Fecha *</span>
					<p-datepicker
						formControlName="fecha"
						appendTo="body"
						dateFormat="dd/mm/yy"
						[showIcon]="true"
						styleClass="w-full"
						[style]="{ width: '100%' }"
					>
					</p-datepicker>
				</div>
				<div class="flex flex-col gap-2">
					<span class="font-bold text-sm text-gray-700">Valor Multa ($) *</span>
					<p-inputNumber
						formControlName="multa"
						mode="currency"
						currency="USD"
						locale="en-US"
						styleClass="w-full"
						placeholder="0.00"
					>
					</p-inputNumber>
				</div>
			</div>

			<div class="flex flex-col gap-2">
				<span class="font-bold text-sm text-gray-700">Lugar de Encuentro *</span>
				<input pInputText formControlName="lugar" placeholder="Ej: Casa Comunal" class="w-full" />
			</div>

			<div class="flex flex-col gap-2">
				<span class="font-bold text-sm text-gray-700">Descripción / Notas</span>
				<textarea
					pInputTextarea
					formControlName="descripcion"
					rows="3"
					placeholder="Detalles adicionales..."
					class="w-full"
				></textarea>
			</div>
		</form>
	</ng-template>

	<ng-template pTemplate="footer">
		<div class="flex justify-end gap-2 mt-2">
			<p-button
				label="Cancelar"
				icon="pi pi-times"
				[text]="true"
				severity="secondary"
				(onClick)="dialogVisible = false"
			></p-button>
			<p-button
				label="Programar"
				icon="pi pi-check"
				(onClick)="guardarEvento()"
				[disabled]="mingaForm.invalid"
			></p-button>
		</div>
	</ng-template>
</p-dialog>
