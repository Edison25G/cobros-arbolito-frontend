<p-toast></p-toast>
<p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>

<div class="mb-6">
	<h2 class="text-3xl font-extrabold text-gray-800 tracking-tight">Mis Pagos y Facturas</h2>
	<p class="text-lg text-gray-500 mt-1">Revisa tu historial de facturas y sube tus comprobantes de pago.</p>
</div>

<div class="p-6 rounded-2xl shadow border border-gray-200 bg-white">
	<p-table
		[value]="misFacturas"
		[loading]="isLoading"
		[paginator]="true"
		[rows]="5"
		paginatorDropdownAppendTo="body"
		dataKey="id"
		[rowHover]="true"
		[tableStyle]="{ 'min-width': '60rem' }"
	>
		<ng-template pTemplate="caption">
			<div class="flex items-center justify-between">
				<span class="text-xl font-semibold text-black">Historial de Facturas</span>
			</div>
		</ng-template>

		<ng-template pTemplate="header">
			<tr>
				<th pSortableColumn="id">Factura N° <p-sortIcon field="id" /></th>
				<th pSortableColumn="fecha_emision">Emitida <p-sortIcon field="fecha_emision" /></th>
				<th pSortableColumn="fecha_vencimiento">Vence <p-sortIcon field="fecha_vencimiento" /></th>
				<th pSortableColumn="total">Total <p-sortIcon field="total" /></th>
				<th pSortableColumn="estado">Estado <p-sortIcon field="estado" /></th>
				<th>Acciones</th>
			</tr>
		</ng-template>

		<ng-template pTemplate="body" let-factura>
			<tr>
				<td class="font-medium text-black">#{{ factura.id }}</td>
				<td class="text-black">{{ factura.fecha_emision | date: 'dd/MM/yyyy' }}</td>
				<td class="text-black">{{ factura.fecha_vencimiento | date: 'dd/MM/yyyy' }}</td>
				<td class="font-bold text-black text-lg">{{ factura.total | currency: 'USD' }}</td>
				<td>
					<p-tag [value]="factura.estado" [severity]="getSeverity(factura.estado)"></p-tag>
				</td>
				<td>
					<div class="flex gap-2">
						<p-button
							*ngIf="factura.estado === EstadoFactura.Pendiente"
							icon="pi pi-upload"
							pTooltip="Subir Pago"
							tooltipPosition="top"
							styleClass="p-button-sm p-button-success"
							(click)="openUploadModal(factura)"
						></p-button>

						<p-button
							icon="pi pi-file"
							pTooltip="Ver Detalle / Imprimir"
							tooltipPosition="top"
							styleClass="p-button-sm p-button-secondary p-button-outlined"
							(click)="verDetalleFactura(factura)"
						></p-button>

						<p-button
							*ngIf="factura.estado === EstadoFactura.Pagada"
							label="Listo"
							icon="pi pi-check"
							severity="success"
							[outlined]="true"
							styleClass="p-button-sm"
						></p-button>
					</div>
				</td>
			</tr>
		</ng-template>

		<ng-template pTemplate="emptymessage">
			<tr>
				<td colspan="6" class="text-black text-center p-4">Aún no tienes facturas registradas.</td>
			</tr>
		</ng-template>
	</p-table>
</div>

<p-dialog
	[(visible)]="showUploadModal"
	[modal]="true"
	[closable]="true"
	header="Subir Comprobante (Factura #{{ facturaSeleccionada?.id }})"
	[style]="{ width: '500px', maxWidth: '90vw' }"
	(onHide)="closeUploadModal()"
>
	<div class="p-4">
		<div class="text-center mb-6">
			<p class="text-lg">
				Total a Pagar:
				<strong class="text-2xl text-emerald-600">{{ facturaSeleccionada?.total | currency: 'USD' }}</strong>
			</p>
			<p class="text-gray-600">Sube foto o PDF de tu transferencia.</p>
		</div>
		<p-fileUpload
			name="comprobante"
			[auto]="true"
			[customUpload]="true"
			(uploadHandler)="onUpload($event)"
			accept="image/*,.pdf"
			[maxFileSize]="5000000"
			chooseLabel="Buscar Archivo"
			uploadLabel="Subir"
			cancelLabel="Cancelar"
		></p-fileUpload>
	</div>
</p-dialog>

<p-dialog
	[(visible)]="showDetailModal"
	[modal]="true"
	[style]="{ width: '400px' }"
	header="Detalle de Cobro"
	[draggable]="false"
	[resizable]="false"
>
	<div *ngIf="facturaSeleccionada" class="p-2" id="printable-ticket">
		<div class="text-center border-b border-gray-300 pb-3 mb-3">
			<h3 class="font-bold text-xl text-emerald-700">El Arbolito</h3>
			<p class="text-sm text-gray-500">Junta de Agua Potable</p>
			<p class="text-xs text-gray-400 mt-1">Recibo N° {{ facturaSeleccionada.id }}</p>
			<p class="text-xs text-gray-400">Fecha: {{ facturaSeleccionada.fecha_emision | date: 'dd/MM/yyyy' }}</p>
		</div>

		<div class="space-y-2 text-sm text-gray-700 mb-4">
			<div class="flex justify-between">
				<span>Lectura Anterior:</span>
				<span class="font-medium">{{ $any(facturaSeleccionada).detalle?.lectura_anterior || 0 }}</span>
			</div>
			<div class="flex justify-between">
				<span>Lectura Actual:</span>
				<span class="font-medium">{{ $any(facturaSeleccionada).detalle?.lectura_actual || 0 }}</span>
			</div>
			<div class="flex justify-between border-b border-dashed border-gray-300 pb-2">
				<span class="font-bold">Consumo Total:</span>
				<span class="font-bold">{{ $any(facturaSeleccionada).detalle?.consumo_total || 0 }} m³</span>
			</div>
		</div>

		<div class="space-y-2 text-sm text-gray-700">
			<div class="flex justify-between">
				<span>Tarifa Base:</span>
				<span>{{ $any(facturaSeleccionada).detalle?.costo_base | currency: 'USD' }}</span>
			</div>

			<div *ngIf="$any(facturaSeleccionada).detalle?.m3_exceso_1" class="flex justify-between text-xs text-amber-700">
				<span>Exceso 11-15m³ ({{ $any(facturaSeleccionada).detalle?.m3_exceso_1 }}m³):</span>
				<span>{{ $any(facturaSeleccionada).detalle?.costo_exceso_1 | currency: 'USD' }}</span>
			</div>

			<div *ngIf="$any(facturaSeleccionada).detalle?.m3_exceso_2" class="flex justify-between text-xs text-red-700">
				<span>Exceso >15m³ ({{ $any(facturaSeleccionada).detalle?.m3_exceso_2 }}m³):</span>
				<span>{{ $any(facturaSeleccionada).detalle?.costo_exceso_2 | currency: 'USD' }}</span>
			</div>
		</div>

		<div class="mt-4 pt-3 border-t-2 border-gray-800 flex justify-between items-center">
			<span class="text-lg font-bold">TOTAL A PAGAR:</span>
			<span class="text-xl font-extrabold text-gray-900">{{ facturaSeleccionada.total | currency: 'USD' }}</span>
		</div>
	</div>

	<ng-template pTemplate="footer">
		<div class="flex justify-center w-full">
			<p-button
				label="Imprimir Recibo"
				icon="pi pi-print"
				(click)="imprimirTicket()"
				styleClass="p-button-outlined p-button-secondary w-full"
			></p-button>
		</div>
	</ng-template>
</p-dialog>
