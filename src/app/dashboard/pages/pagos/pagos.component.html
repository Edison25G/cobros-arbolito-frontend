<p-toast position="bottom-right"></p-toast>
<p-confirmDialog [style]="{ width: '450px' }" styleClass="modern-confirm-dialog"></p-confirmDialog>

<div class="h-full flex flex-col p-4 md:p-8 bg-slate-50/50 animate-fade-in font-sans overflow-hidden">
	<div class="flex-none flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-6">
		<div>
			<h2 class="text-3xl font-extrabold text-slate-800 tracking-tight flex items-center gap-3">
				<i class="pi pi-wallet text-emerald-500"></i>
				Mis Pagos y Facturas
			</h2>
			<p class="text-slate-500 text-sm mt-1 ml-1">Consulta tus estados de cuenta y reporta tus transferencias.</p>
		</div>

		<div class="flex gap-3">
			<div class="flex items-center px-4 py-2 bg-emerald-50 rounded-xl border border-emerald-100 shadow-sm">
				<div class="flex flex-col">
					<span class="text-[10px] font-bold text-emerald-600 uppercase tracking-widest leading-none mb-1"
						>Estado de Cuenta</span
					>
					<span class="text-sm font-black text-emerald-700 uppercase">Socio Activo</span>
				</div>
			</div>
		</div>
	</div>

	<div class="flex-1 min-h-0 bg-white rounded-3xl shadow-xl border border-slate-100 flex flex-col overflow-hidden">
		<p-table
			[value]="misFacturas"
			[loading]="isLoading"
			[paginator]="true"
			[rows]="10"
			[rowHover]="true"
			[scrollable]="true"
			scrollHeight="flex"
			styleClass="p-datatable-modern h-full"
			currentPageReportTemplate="Mostrando {first}-{last} de {totalRecords}"
			[showCurrentPageReport]="true"
		>
			<ng-template pTemplate="caption">
				<div class="flex items-center px-4 py-3 bg-slate-50/50 border-b border-slate-100">
					<h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider flex items-center gap-2 m-0">
						<i class="pi pi-list text-emerald-500"></i> Historial de Transacciones
					</h3>
				</div>
			</ng-template>

			<ng-template pTemplate="header">
				<tr
					class="bg-slate-50 text-[10px] uppercase font-black text-slate-500 tracking-widest border-b border-slate-100"
				>
					<th class="pl-8 py-4">Factura ID</th>
					<th class="text-center">Emisión</th>
					<th class="text-center">Vencimiento</th>
					<th class="text-right">Total a Pagar</th>
					<th class="text-center">Estado</th>
					<th class="text-center pr-8">Acciones</th>
				</tr>
			</ng-template>

			<ng-template pTemplate="body" let-factura>
				<tr class="hover:bg-slate-50 transition-all border-b border-slate-50 last:border-0 group">
					<td class="pl-8 py-4">
						<div class="flex items-center gap-2">
							<span
								class="w-8 h-8 rounded-lg bg-slate-100 text-slate-500 flex items-center justify-center font-mono text-xs"
								>#</span
							>
							<span class="font-bold text-slate-700 text-sm">{{ factura.id }}</span>
						</div>
					</td>
					<td class="text-center text-xs text-slate-500 font-medium">
						{{ factura.fecha_emision | date: 'dd MMM yyyy' }}
					</td>
					<td
						class="text-center text-xs font-bold"
						[ngClass]="
							(factura.estado_financiero || factura.estado) === EstadoFinanciero.PENDIENTE
								? 'text-red-400'
								: 'text-slate-400'
						"
					>
						{{ factura.fecha_vencimiento | date: 'dd MMM yyyy' }}
					</td>
					<td class="text-right" colspan="3">
						<!-- Metadatos de la Factura -->
						<div class="space-y-3 relative z-10 w-full">
							<!-- Badge de Estado -->
							<div class="flex justify-between items-start">
								<span
									class="px-3 py-1 text-xs font-semibold rounded-full border shadow-sm flex items-center gap-1.5 backdrop-blur-sm"
									[ngClass]="{
										'bg-emerald-50 text-emerald-700 border-emerald-100':
											(factura.estado_financiero || factura.estado) === EstadoFinanciero.PAGADA,
										'bg-orange-50 text-orange-600 border-orange-100':
											(factura.estado_financiero || factura.estado) === EstadoFinanciero.PENDIENTE,
										'bg-blue-50 text-blue-600 border-blue-100':
											(factura.estado_financiero || factura.estado) === 'POR_VALIDAR',
									}"
								>
									<i
										class="pi text-[10px]"
										[ngClass]="{
											'pi-check-circle': (factura.estado_financiero || factura.estado) === EstadoFinanciero.PAGADA,
											'pi-clock': (factura.estado_financiero || factura.estado) === EstadoFinanciero.PENDIENTE,
											'pi-spin pi-spinner': (factura.estado_financiero || factura.estado) === 'POR_VALIDAR',
										}"
									></i>
									{{ factura.estado_financiero || factura.estado | uppercase }}
								</span>
								<span
									*ngIf="factura.estado_sri"
									class="px-2 py-1 text-[9px] font-bold rounded-full border shadow-sm flex items-center gap-1 bg-white/80"
									[ngClass]="{
										'text-emerald-600 border-emerald-200': factura.estado_sri === 'AUTORIZADA',
										'text-orange-500 border-orange-200':
											factura.estado_sri === 'PENDIENTE_SRI' || factura.estado_sri === 'DEVUELTA',
										'text-blue-500 border-blue-200': factura.estado_sri === 'PENDIENTE_FIRMA',
										'text-red-500 border-red-200': factura.estado_sri === 'ERROR' || factura.estado_sri === 'RECHAZADA',
										'text-slate-500 border-slate-200': factura.estado_sri === 'NO_ENVIADA',
									}"
									[pTooltip]="
										factura.estado_sri === 'DEVUELTA' ||
										factura.estado_sri === 'RECHAZADA' ||
										factura.estado_sri === 'ERROR'
											? factura.sri_mensaje_error || factura.mensaje_error_sri || 'Error de validación SRI'
											: 'Estado SRI'
									"
									tooltipPosition="left"
								>
									<i
										class="pi"
										[ngClass]="{
											'pi-clock': factura.estado_sri === 'PENDIENTE_SRI',
											'pi-check-circle': factura.estado_sri === 'AUTORIZADA',
											'pi-exclamation-triangle':
												factura.estado_sri === 'DEVUELTA' ||
												factura.estado_sri === 'RECHAZADA' ||
												factura.estado_sri === 'ERROR',
											'pi-info-circle':
												factura.estado_sri !== 'PENDIENTE_SRI' &&
												factura.estado_sri !== 'AUTORIZADA' &&
												factura.estado_sri !== 'DEVUELTA' &&
												factura.estado_sri !== 'RECHAZADA' &&
												factura.estado_sri !== 'ERROR',
										}"
									></i>
									{{ factura.estado_sri }}
								</span>
							</div>

							<!-- Total y Fechas -->
							<div class="bg-white/60 p-3 rounded-lg border border-white space-y-2 backdrop-blur-md">
								<div>
									<p class="text-[10px] text-slate-500 font-medium uppercase tracking-wider mb-0.5">Total a Pagar</p>
									<p
										class="text-xl font-bold"
										[ngClass]="
											(factura.estado_financiero || factura.estado) === EstadoFinanciero.PENDIENTE
												? 'text-red-600'
												: 'text-slate-800'
										"
									>
										{{ factura.total | currency }}
									</p>
								</div>
								<div class="flex justify-between items-center text-xs">
									<div class="text-slate-600">
										<i class="pi pi-calendar mr-1 text-slate-400"></i>
										Emisión: {{ factura.fecha_emision | date: 'dd/MM/yyyy' }}
									</div>
								</div>
							</div>

							<!-- Botones de Acción Múltiples (Flex Wrap) -->
							<div class="flex flex-wrap gap-2 pt-2 mt-auto">
								<!-- SI ESTÁ PENDIENTE: Pagar -->
								<button
									*ngIf="(factura.estado_financiero || factura.estado) === EstadoFinanciero.PENDIENTE"
									(click)="openUploadModal(factura)"
									class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white shadow-md shadow-emerald-500/20 px-3 py-2 rounded-lg font-semibold text-xs transition-all flex items-center justify-center gap-2"
								>
									<i class="pi pi-wallet"></i> Pagar
								</button>

								<!-- SI ESTÁ PAGADA y AUTORIZADA: Imprimir Ticket -->
								<button
									*ngIf="
										(factura.estado_financiero || factura.estado) === EstadoFinanciero.PAGADA &&
										factura.estado_sri === 'AUTORIZADA'
									"
									(click)="verDetalleFactura(factura)"
									class="flex-1 bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 shadow-sm px-3 py-2 rounded-lg font-semibold text-xs transition-all flex items-center justify-center gap-2"
								>
									<i class="pi pi-print"></i> Ticket
								</button>

								<!-- SI ESTÁ PAGADA y AUTORIZADA: Ver SRI -->
								<button
									*ngIf="
										(factura.estado_financiero || factura.estado) === EstadoFinanciero.PAGADA &&
										factura.estado_sri === 'AUTORIZADA'
									"
									class="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 shadow-sm px-3 py-2 rounded-lg font-semibold text-xs transition-all flex items-center justify-center gap-2"
								>
									<i class="pi pi-external-link"></i> SRI
								</button>
							</div>
						</div>
					</td>
				</tr>
			</ng-template>
			<ng-template pTemplate="emptymessage">
				<tr>
					<td colspan="6" class="text-center py-12">
						<div class="flex flex-col items-center gap-3">
							<div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center">
								<i class="pi pi-search text-slate-300 text-3xl"></i>
							</div>
							<span class="text-slate-500 font-medium">No se encontraron facturas o pagos pendientes.</span>
						</div>
					</td>
				</tr>
			</ng-template>
		</p-table>
	</div>
</div>

<p-dialog
	[(visible)]="showUploadModal"
	[modal]="true"
	[draggable]="false"
	[resizable]="false"
	header=" "
	[style]="{ width: '420px' }"
	styleClass="p-dialog-modern"
	(onHide)="closeUploadModal()"
>
	<ng-template pTemplate="header">
		<div class="flex items-center gap-3 w-full border-b border-slate-100 pb-3">
			<div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600 shadow-sm">
				<i class="pi pi-camera"></i>
			</div>
			<div>
				<h3 class="font-bold text-lg text-slate-800 m-0 leading-none">Confirmar Pago</h3>
				<p class="text-[10px] text-slate-400 m-0 uppercase font-black mt-1">Sube tu comprobante de transferencia</p>
			</div>
		</div>
	</ng-template>

	<div class="flex flex-col gap-6 pt-4 px-1" *ngIf="facturaSeleccionada">
		<div class="text-center bg-slate-900 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden">
			<div class="relative z-10">
				<span class="block text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em] mb-2">Valor a Reportar</span>
				<span class="text-4xl font-black block text-emerald-400 leading-none mb-1">
					{{ facturaSeleccionada.total | currency: 'USD' }}
				</span>
				<span class="text-[10px] text-slate-500 font-mono tracking-widest uppercase"
					>Factura #{{ facturaSeleccionada.id }}</span
				>
			</div>
			<div class="absolute -right-4 -bottom-4 pi pi-money-bill text-7xl opacity-5 rotate-12"></div>
		</div>

		<div class="flex flex-col gap-1.5">
			<span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest pl-1"
				>Referencia Bancaria / N° Documento</span
			>
			<input
				pInputText
				[(ngModel)]="referenciaInput"
				placeholder="Ej: 0098231"
				class="w-full !rounded-xl !border-slate-200 !py-3 focus:!border-emerald-500 transition-all text-center font-bold tracking-widest"
			/>
		</div>

		<div class="flex flex-col gap-1.5">
			<span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest pl-1">Captura del Comprobante</span>
			<div
				class="flex items-center gap-3 p-3 border border-dashed border-slate-300 rounded-2xl bg-slate-50 hover:bg-white hover:border-emerald-400 transition-all cursor-pointer relative overflow-hidden group"
			>
				<p-fileUpload
					mode="basic"
					chooseLabel="Cámara / Galería"
					chooseIcon="pi pi-camera"
					accept="image/*"
					maxFileSize="5000000"
					(onSelect)="onFileSelect($event)"
					styleClass="!bg-slate-800 !border-slate-800 !rounded-xl !text-xs !font-bold"
				></p-fileUpload>

				<div class="flex-1 min-w-0">
					<span *ngIf="!archivoSeleccionado" class="text-xs text-slate-400 font-medium truncate block"
						>No hay archivo...</span
					>
					<span *ngIf="archivoSeleccionado" class="text-xs text-emerald-600 font-bold truncate block animate-fade-in">
						<i class="pi pi-check"></i> {{ archivoSeleccionado.name }}
					</span>
				</div>
			</div>
		</div>
	</div>

	<ng-template pTemplate="footer">
		<div class="flex justify-between items-center w-full pt-4 border-t border-slate-100">
			<p-button
				label="Descartar"
				[text]="true"
				severity="secondary"
				(onClick)="closeUploadModal()"
				styleClass="text-sm font-bold"
			></p-button>
			<p-button
				label="Reportar Pago"
				icon="pi pi-send"
				[loading]="isUploading"
				[disabled]="!archivoSeleccionado || !referenciaInput"
				styleClass="!bg-emerald-600 !border-emerald-600 hover:!bg-emerald-700 !rounded-xl !px-6 text-sm shadow-lg shadow-emerald-100"
				(onClick)="enviarComprobante()"
			>
			</p-button>
		</div>
	</ng-template>
</p-dialog>
