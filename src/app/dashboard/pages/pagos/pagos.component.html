<p-toast></p-toast>
<p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>

<!-- Encabezado -->
<div class="mb-6">
	<h2 class="text-3xl font-extrabold text-gray-800 tracking-tight">Mis Pagos y Facturas</h2>
	<p class="text-lg text-gray-500 mt-1">Revisa tu historial de facturas y sube tus comprobantes de pago.</p>
</div>

<!-- Tabla de Facturas del Socio -->
<div class="p-6 rounded-2xl shadow border border-gray-200 bg-white">
	<p-table
		[value]="misFacturas"
		[loading]="isLoading"
		[paginator]="true"
		[rows]="10"
		dataKey="id"
		[rowHover]="true"
		[tableStyle]="{ 'min-width': '60rem' }"
	>
		<ng-template pTemplate="caption">
			<div class="flex items-center justify-between">
				<span class="text-xl font-semibold text-black">Historial de Facturas</span>
			</div>
		</ng-template>

		<ng-template pTemplate="header">
			<tr>
				<th pSortableColumn="id">Factura N° <p-sortIcon field="id" /></th>
				<th pSortableColumn="fecha_emision">Emitida <p-sortIcon field="fecha_emision" /></th>
				<th pSortableColumn="fecha_vencimiento">Vence <p-sortIcon field="fecha_vencimiento" /></th>
				<th pSortableColumn="total">Total <p-sortIcon field="total" /></th>
				<th pSortableColumn="estado">Estado <p-sortIcon field="estado" /></th>
				<th>Acciones</th>
			</tr>
		</ng-template>

		<ng-template pTemplate="body" let-factura>
			<tr>
				<td class="font-medium text-black">#{{ factura.id }}</td>
				<td class="text-black">{{ factura.fecha_emision | date: 'dd/MM/yyyy' }}</td>
				<td class="text-black">{{ factura.fecha_vencimiento | date: 'dd/MM/yyyy' }}</td>
				<td class="font-bold text-black text-lg">{{ factura.total | currency: 'USD' }}</td>
				<td>
					<p-tag [value]="factura.estado" [severity]="getSeverity(factura.estado)"></p-tag>
				</td>
				<td>
					<!-- Lógica de Botones -->

					<!-- 1. Si está PENDIENTE: Mostrar botón "Subir Comprobante" -->
					<p-button
						*ngIf="factura.estado === EstadoFactura.Pendiente"
						label="Subir Comprobante"
						icon="pi pi-upload"
						(click)="openUploadModal(factura)"
					></p-button>

					<!-- 2. Si está EN VERIFICACIÓN: Mostrar texto y deshabilitar -->
					<p-button
						*ngIf="factura.estado === EstadoFactura.EnVerificacion"
						label="En Verificación"
						icon="pi pi-clock"
						[disabled]="true"
						severity="info"
						[outlined]="true"
					></p-button>

					<!-- 3. Si está PAGADA: Mostrar botón de "Ver" (o imprimir) -->
					<p-button
						*ngIf="factura.estado === EstadoFactura.Pagada"
						label="Pagada"
						icon="pi pi-check"
						severity="success"
						[outlined]="true"
						(click)="verFactura(factura.id)"
					></p-button>

					<!-- 4. Si está ANULADA: No mostrar nada o un tag -->
				</td>
			</tr>
		</ng-template>

		<ng-template pTemplate="emptymessage">
			<tr>
				<td colspan="6" class="text-black text-center p-4">Aún no tienes facturas registradas.</td>
			</tr>
		</ng-template>
	</p-table>
</div>

<!-- MODAL (p-dialog) para Subir Comprobante -->
<p-dialog
	[(visible)]="showUploadModal"
	[modal]="true"
	[closable]="true"
	header="Subir Comprobante de Pago (Factura #{{ facturaSeleccionada?.id }})"
	[style]="{ width: '500px', maxWidth: '90vw' }"
	(onHide)="closeUploadModal()"
>
	<div class="p-4">
		<div class="text-center mb-6">
			<p class="text-lg">
				Total a Pagar:
				<strong class="text-2xl text-emerald-600">{{ facturaSeleccionada?.total | currency: 'USD' }}</strong>
			</p>
			<p class="text-gray-600">Por favor, sube una foto o PDF de tu transferencia o depósito bancario.</p>
		</div>

		<!--
      Componente de Carga de Archivos de PrimeNG
      - auto: Sube el archivo automáticamente al seleccionarlo.
      - customUpload: Le dice a PrimeNG que usaremos nuestra propia lógica (el método onUpload).
      - accept: Limita los tipos de archivo.
      - maxFileSize: Límite de 5MB (ajústalo si es necesario).
    -->
		<p-fileUpload
			name="comprobante"
			[auto]="true"
			[customUpload]="true"
			(uploadHandler)="onUpload($event)"
			accept="image/*,.pdf"
			[maxFileSize]="5000000"
			[showCancelButton]="false"
			[disabled]="isUploading"
			chooseLabel="Buscar Archivo"
			uploadLabel="Subir"
			cancelLabel="Cancelar"
		>
			<ng-template pTemplate="empty">
				<div class="flex items-center justify-center flex-col">
					<i class="pi pi-cloud-upload text-4xl text-gray-400"></i>
					<p class="mt-2 text-gray-600">Arrastra y suelta tu archivo aquí o haz clic.</p>
				</div>
			</ng-template>
		</p-fileUpload>
	</div>
</p-dialog>
