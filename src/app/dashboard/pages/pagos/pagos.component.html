<p-toast></p-toast>
<p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>

<div class="mb-6">
	<h2 class="text-3xl font-extrabold text-gray-800 tracking-tight">Mis Pagos y Facturas</h2>
	<p class="text-lg text-gray-500 mt-1">Revisa tu historial de facturas y sube tus comprobantes de pago.</p>
</div>

<div class="p-6 rounded-2xl shadow border border-gray-200 bg-white">
	<p-table
		[value]="misFacturas"
		[loading]="isLoading"
		[paginator]="true"
		[rows]="5"
		paginatorDropdownAppendTo="body"
		dataKey="id"
		[rowHover]="true"
		[tableStyle]="{ 'min-width': '60rem' }"
	>
		<ng-template pTemplate="caption">
			<div class="flex items-center justify-between">
				<span class="text-xl font-semibold text-black">Historial de Facturas</span>
			</div>
		</ng-template>

		<ng-template pTemplate="header">
			<tr>
				<th pSortableColumn="id">Factura N° <p-sortIcon field="id" /></th>
				<th pSortableColumn="fecha_emision">Emitida <p-sortIcon field="fecha_emision" /></th>
				<th pSortableColumn="fecha_vencimiento">Vence <p-sortIcon field="fecha_vencimiento" /></th>
				<th pSortableColumn="total">Total <p-sortIcon field="total" /></th>
				<th pSortableColumn="estado">Estado <p-sortIcon field="estado" /></th>
				<th>Acciones</th>
			</tr>
		</ng-template>

		<ng-template pTemplate="body" let-factura>
			<tr>
				<td class="font-medium text-black">#{{ factura.id }}</td>
				<td class="text-black">{{ factura.fecha_emision | date: 'dd/MM/yyyy' }}</td>
				<td class="text-black">{{ factura.fecha_vencimiento | date: 'dd/MM/yyyy' }}</td>
				<td class="font-bold text-black text-lg">{{ factura.total | currency: 'USD' }}</td>
				<td>
					<p-tag [value]="factura.estado" [severity]="getSeverity(factura.estado)"></p-tag>
				</td>
				<td>
					<div class="flex gap-2">
						<p-button
							*ngIf="factura.estado === EstadoFactura.Pendiente"
							icon="pi pi-upload"
							pTooltip="Subir Pago"
							tooltipPosition="top"
							styleClass="p-button-sm p-button-success"
							(click)="openUploadModal(factura)"
						></p-button>

						<p-button
							icon="pi pi-file"
							pTooltip="Ver Detalle / Imprimir"
							tooltipPosition="top"
							styleClass="p-button-sm p-button-secondary p-button-outlined"
							(click)="verDetalleFactura(factura)"
							[disabled]="factura.estado !== EstadoFactura.Pagada"
						></p-button>

						<p-button
							*ngIf="factura.estado === EstadoFactura.Pagada"
							label="Listo"
							icon="pi pi-check"
							severity="success"
							[outlined]="true"
							styleClass="p-button-sm"
						></p-button>
					</div>
				</td>
			</tr>
		</ng-template>

		<ng-template pTemplate="emptymessage">
			<tr>
				<td colspan="6" class="text-black text-center p-4">Aún no tienes facturas registradas.</td>
			</tr>
		</ng-template>
	</p-table>
</div>

<p-dialog
	[(visible)]="showUploadModal"
	[modal]="true"
	[closable]="true"
	[draggable]="false"
	[resizable]="false"
	appendTo="body"
	header="Subir Comprobante"
	[style]="{ width: '380px' }"
	(onHide)="closeUploadModal()"
>
	<div class="flex flex-col gap-5 pt-2" *ngIf="facturaSeleccionada">
		<div class="text-center bg-gray-50 p-4 rounded-xl border border-gray-100 shadow-sm">
			<span class="block text-gray-500 text-xs font-bold uppercase tracking-wide mb-1">TOTAL A TRANSFERIR</span>
			<span class="text-4xl text-emerald-600 font-bold block">
				{{ facturaSeleccionada.total | currency: 'USD' }}
			</span>
			<span class="text-xs text-gray-400 mt-1">Factura #{{ facturaSeleccionada.id }}</span>
		</div>

		<div class="flex flex-col gap-2">
			<span class="font-bold text-gray-700 text-sm pl-1">Referencia Bancaria</span>
			<input
				pInputText
				[(ngModel)]="referenciaInput"
				placeholder="Ej: 123456789"
				class="w-full p-3 border border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-all"
			/>
		</div>

		<div class="flex flex-col gap-2">
			<span class="font-bold text-gray-700 text-sm pl-1">Foto del Recibo</span>

			<div
				class="flex items-center gap-3 p-2 border border-gray-300 rounded-lg bg-white hover:border-emerald-400 transition-colors"
			>
				<p-fileUpload
					mode="basic"
					chooseLabel="Foto"
					chooseIcon="pi pi-camera"
					accept="image/*"
					maxFileSize="5000000"
					(onSelect)="onFileSelect($event)"
					[auto]="false"
					styleClass="p-button-sm bg-emerald-600 border-emerald-600"
				>
				</p-fileUpload>

				<div class="flex-1 overflow-hidden">
					<span *ngIf="!archivoSeleccionado" class="text-xs text-gray-400 italic"> Sube tu captura... </span>
					<span *ngIf="archivoSeleccionado" class="text-sm text-emerald-700 font-medium flex items-center gap-1">
						<i class="pi pi-check-circle"></i>
						<span class="truncate w-32">
							{{ archivoSeleccionado.name }}
						</span>
					</span>
				</div>
			</div>
		</div>

		<div class="flex justify-between items-center pt-2 mt-2 border-t border-gray-100">
			<p-button
				label="Cancelar"
				icon="pi pi-times"
				[text]="true"
				severity="secondary"
				styleClass="p-button-sm text-gray-500 hover:text-gray-700"
				(onClick)="closeUploadModal()"
			>
			</p-button>

			<p-button
				label="Enviar Pago"
				icon="pi pi-send"
				[rounded]="true"
				styleClass="p-button-sm bg-emerald-600 border-emerald-600 hover:bg-emerald-700 font-bold px-4 border-none"
				(onClick)="enviarComprobante()"
				[loading]="isUploading"
				[disabled]="!archivoSeleccionado || !referenciaInput"
			>
			</p-button>
		</div>
	</div>
</p-dialog>

<p-dialog
	[(visible)]="showDetailModal"
	[modal]="true"
	[style]="{ width: '400px' }"
	header="Detalle de Cobro"
	[draggable]="false"
	[resizable]="false"
>
	<div *ngIf="facturaSeleccionada" class="p-2">
		<div class="text-center border-b border-gray-300 pb-3 mb-3">
			<h3 class="font-bold text-xl text-emerald-700">Junta "El Arbolito"</h3>
			<p class="text-sm text-gray-500">Recibo N° {{ facturaSeleccionada.id }}</p>
			<p class="text-xs text-gray-400">Fecha: {{ facturaSeleccionada.fecha_emision | date: 'dd/MM/yyyy' }}</p>
		</div>

		<div class="space-y-2 text-sm text-gray-700 mb-4" *ngIf="facturaSeleccionada.detalle?.consumo_total! > 0">
			<div class="flex justify-between">
				<span>Consumo Total:</span>
				<span class="font-bold">{{ facturaSeleccionada.detalle?.consumo_total }} m³</span>
			</div>
		</div>

		<div class="text-center py-4 italic text-gray-500 text-sm" *ngIf="facturaSeleccionada.detalle?.consumo_total === 0">
			Servicio de Acometida de Agua (Tarifa Fija)
		</div>

		<div class="mt-4 pt-3 border-t-2 border-gray-800 flex justify-between items-center">
			<span class="text-lg font-bold">TOTAL:</span>
			<span class="text-xl font-extrabold text-gray-900">{{ facturaSeleccionada.total | currency: 'USD' }}</span>
		</div>
	</div>

	<ng-template pTemplate="footer">
		<div class="flex justify-center w-full">
			<p-button
				label="Imprimir Recibo"
				icon="pi pi-print"
				(click)="imprimirTicket()"
				styleClass="p-button-outlined p-button-secondary w-full"
			></p-button>
		</div>
	</ng-template>
</p-dialog>
